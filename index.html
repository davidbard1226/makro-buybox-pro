<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Makro BuyBox Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  :root {
    --bg: #0a0c10;
    --surface: #111418;
    --surface2: #181c22;
    --border: #1e2530;
    --accent: #00e5a0;
    --accent2: #ff9500;
    --accent3: #ffd60a;
    --text: #e8eaf0;
    --muted: #6b7280;
    --win: #00e5a0;
    --lose: #ff9500;
    --warn: #ffd60a;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* GRID BACKGROUND */
  body::before {
    content:'';
    position:fixed;
    inset:0;
    background-image:
      linear-gradient(rgba(0,229,160,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,160,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events:none;
    z-index:0;
  }

  #app { position:relative; z-index:1; display:flex; flex-direction:column; height:100vh; }

  /* HEADER */
  header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    display:flex;
    align-items:center;
    gap:24px;
    height: 60px;
    flex-shrink:0;
  }

  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 26px;
    letter-spacing: 2px;
    color: var(--accent);
    display:flex;
    align-items:center;
    gap:8px;
  }

  .logo-dot { width:8px; height:8px; background:var(--accent); border-radius:50%; box-shadow:0 0 10px var(--accent); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.3)} }

  .ext-status {
    margin-left:auto;
    display:flex;
    align-items:center;
    gap:8px;
    font-family:'Space Mono', monospace;
    font-size:11px;
    padding: 6px 14px;
    border-radius: 20px;
    border: 1px solid var(--border);
    background: var(--bg);
  }

  .ext-dot { width:7px; height:7px; border-radius:50%; background:var(--muted); }
  .ext-dot.green { background:var(--accent); box-shadow:0 0 8px var(--accent); }
  .ext-dot.red { background:var(--accent2); }

  .seller-badge {
    font-family:'Space Mono',monospace;
    font-size:11px;
    color:var(--accent3);
    padding:5px 12px;
    border:1px solid rgba(255,214,10,.3);
    border-radius:20px;
    background: rgba(255,214,10,.05);
  }

  /* NAV TABS */
  nav {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    display:flex;
    gap:4px;
    flex-shrink:0;
  }

  .tab-btn {
    background:none;
    border:none;
    color:var(--muted);
    font-family:'DM Sans',sans-serif;
    font-size:13px;
    font-weight:500;
    padding:14px 18px;
    cursor:pointer;
    position:relative;
    transition: color .2s;
  }

  .tab-btn::after {
    content:'';
    position:absolute;
    bottom:0; left:0; right:0;
    height:2px;
    background:var(--accent);
    transform:scaleX(0);
    transition: transform .2s;
  }

  .tab-btn.active { color:var(--text); }
  .tab-btn.active::after { transform:scaleX(1); }
  .tab-btn:hover { color:var(--text); }

  .tab-badge {
    display:inline-flex;
    align-items:center;
    justify-content:center;
    background:var(--accent);
    color:#000;
    font-size:9px;
    font-weight:700;
    width:16px; height:16px;
    border-radius:50%;
    margin-left:6px;
  }

  /* CONTENT */
  main { flex:1; overflow-y:auto; padding:24px; }

  .tab-content { display:none; }
  .tab-content.active { display:block; animation: fadeIn .3s ease; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)} }

  /* STAT CARDS */
  .stats-grid {
    display:grid;
    grid-template-columns: repeat(4,1fr);
    gap:16px;
    margin-bottom:24px;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius:12px;
    padding:20px;
    position:relative;
    overflow:hidden;
  }

  .stat-card::before {
    content:'';
    position:absolute;
    top:0; left:0; right:0;
    height:2px;
    background: linear-gradient(90deg, var(--accent), transparent);
  }

  .stat-card.red::before { background: linear-gradient(90deg, var(--accent2), transparent); }
  .stat-card.yellow::before { background: linear-gradient(90deg, var(--accent3), transparent); }
  .stat-card.blue::before { background: linear-gradient(90deg, #60a5fa, transparent); }

  .stat-label { font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
  .stat-value { font-family:'Bebas Neue',sans-serif; font-size:42px; line-height:1; color:var(--text); }
  .stat-value.accent { color:var(--accent); }
  .stat-value.red { color:var(--accent2); }
  .stat-value.yellow { color:var(--accent3); }
  .stat-sub { font-size:11px; color:var(--muted); margin-top:6px; }

  /* CHART */
  .chart-row { display:grid; grid-template-columns:1fr 320px; gap:16px; margin-bottom:24px; }

  .card {
    background: var(--surface);
    border:1px solid var(--border);
    border-radius:12px;
    padding:20px;
  }

  .card-title {
    font-family:'Space Mono',monospace;
    font-size:11px;
    text-transform:uppercase;
    letter-spacing:2px;
    color:var(--muted);
    margin-bottom:16px;
  }

  /* WIN/LOSE DONUT */
  .donut-wrap { display:flex; align-items:center; gap:24px; }
  .donut-canvas { width:120px; height:120px; }
  .donut-legend { flex:1; }
  .legend-item { display:flex; align-items:center; gap:8px; margin-bottom:10px; }
  .legend-dot { width:10px; height:10px; border-radius:2px; flex-shrink:0; }
  .legend-label { font-size:13px; color:var(--text); }
  .legend-val { margin-left:auto; font-family:'Space Mono',monospace; font-size:12px; font-weight:700; }

  /* BAR CHART */
  .bar-chart { display:flex; flex-direction:column; gap:8px; }
  .bar-row { display:flex; align-items:center; gap:10px; }
  .bar-label { font-size:12px; color:var(--muted); width:100px; text-align:right; flex-shrink:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .bar-track { flex:1; height:22px; background:var(--surface2); border-radius:4px; overflow:hidden; }
  .bar-fill { height:100%; border-radius:4px; transition:width .8s ease; display:flex; align-items:center; justify-content:flex-end; padding-right:6px; }
  .bar-fill-val { font-size:10px; font-family:'Space Mono',monospace; }

  /* PRODUCT TABLE */
  .product-table { width:100%; border-collapse:collapse; }
  .product-table th {
    font-family:'Space Mono',monospace;
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:1px;
    color:var(--muted);
    padding:10px 12px;
    text-align:left;
    border-bottom:1px solid var(--border);
  }
  .product-table td { padding:12px 12px; border-bottom:1px solid rgba(30,37,48,.5); vertical-align:middle; }
  .product-table tr:hover td { background:rgba(0,229,160,.03); }
  .product-table tr:last-child td { border:none; }

  .prod-title { font-size:13px; font-weight:500; line-height:1.4; max-width:280px; }
  .prod-url { font-size:11px; color:var(--accent); text-decoration:none; display:block; font-family:'Space Mono',monospace; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:200px; }
  .prod-url:hover { text-decoration:underline; }

  .price-cell { font-family:'Space Mono',monospace; font-size:14px; font-weight:700; }
  .price-cell.win { color:var(--accent); }
  .price-cell.lose { color:var(--accent2); }

  .status-pill {
    display:inline-flex;
    align-items:center;
    gap:5px;
    padding:3px 10px;
    border-radius:20px;
    font-size:11px;
    font-weight:600;
    font-family:'Space Mono',monospace;
  }

  .status-pill.win { background:rgba(0,229,160,.1); color:var(--accent); border:1px solid rgba(0,229,160,.2); }
  .status-pill.lose { background:rgba(255,77,109,.1); color:var(--accent2); border:1px solid rgba(255,77,109,.2); }
  .status-pill.unknown { background:rgba(107,114,128,.1); color:var(--muted); border:1px solid rgba(107,114,128,.2); }

  .action-btn {
    background: none;
    border:1px solid var(--border);
    color:var(--muted);
    padding:4px 10px;
    border-radius:6px;
    font-size:11px;
    cursor:pointer;
    transition: all .2s;
  }
  .action-btn:hover { border-color:var(--accent); color:var(--accent); }
  .action-btn.danger:hover { border-color:var(--accent2); color:var(--accent2); }

  /* SCRAPER TAB */
  .scraper-layout { display:grid; grid-template-columns:1fr 360px; gap:20px; }

  .url-input-area {
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:8px;
    width:100%;
    height:220px;
    color:var(--text);
    font-family:'Space Mono',monospace;
    font-size:12px;
    padding:14px;
    resize:vertical;
    outline:none;
    line-height:1.8;
  }
  .url-input-area:focus { border-color:var(--accent); }
  .url-input-area::placeholder { color:var(--muted); }

  .scraper-config { display:flex; flex-direction:column; gap:14px; }
  
  .config-field label { display:block; font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; }
  
  .config-input {
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:6px;
    color:var(--text);
    font-family:'DM Sans',sans-serif;
    font-size:13px;
    padding:9px 12px;
    width:100%;
    outline:none;
  }
  .config-input:focus { border-color:var(--accent); }

  .btn-primary {
    background: var(--accent);
    color:#000;
    border:none;
    border-radius:8px;
    padding:12px 24px;
    font-family:'DM Sans',sans-serif;
    font-size:14px;
    font-weight:600;
    cursor:pointer;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    transition: all .2s;
    width:100%;
  }
  .btn-primary:hover { background:#00ffb0; transform:translateY(-1px); }
  .btn-primary:disabled { background:var(--muted); cursor:not-allowed; transform:none; }

  .btn-secondary {
    background: none;
    color:var(--text);
    border:1px solid var(--border);
    border-radius:8px;
    padding:10px 20px;
    font-family:'DM Sans',sans-serif;
    font-size:13px;
    font-weight:500;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:8px;
    transition: all .2s;
    width:100%;
    justify-content:center;
  }
  .btn-secondary:hover { border-color:var(--accent); color:var(--accent); }

  /* PROGRESS */
  .progress-section { margin-top:16px; }
  .progress-track { background:var(--surface2); border-radius:4px; height:6px; overflow:hidden; }
  .progress-fill { height:100%; background:var(--accent); border-radius:4px; transition:width .3s; box-shadow:0 0 10px var(--accent); }
  .progress-label { font-family:'Space Mono',monospace; font-size:11px; color:var(--muted); margin-bottom:6px; display:flex; justify-content:space-between; }

  /* SCRAPE LOG */
  .scrape-log {
    margin-top:16px;
    background:var(--bg);
    border:1px solid var(--border);
    border-radius:8px;
    padding:12px 14px;
    height:200px;
    overflow-y:auto;
    font-family:'Space Mono',monospace;
    font-size:11px;
    line-height:1.9;
  }

  .log-line { display:flex; gap:10px; }
  .log-time { color:var(--muted); flex-shrink:0; }
  .log-ok { color:var(--accent); }
  .log-err { color:var(--accent2); }
  .log-info { color:var(--accent3); }

  /* ANALYTICS */
  .analytics-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .analytics-full { grid-column:1/-1; }

  .timeline-wrap { overflow-x:auto; }
  .timeline-chart { min-width:600px; }

  /* EMPTY STATE */
  .empty-state {
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    padding:60px 20px;
    text-align:center;
    gap:12px;
  }
  .empty-icon { font-size:48px; opacity:.3; }
  .empty-title { font-family:'Bebas Neue',sans-serif; font-size:28px; color:var(--muted); }
  .empty-text { font-size:13px; color:var(--muted); max-width:300px; }

  /* IMPORT/EXPORT ROW */
  .toolbar {
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:20px;
  }

  .toolbar-right { margin-left:auto; display:flex; gap:8px; }

  .filter-input {
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:6px;
    color:var(--text);
    font-size:13px;
    padding:8px 14px;
    outline:none;
    width:220px;
  }
  .filter-input:focus { border-color:var(--accent); }

  .filter-select {
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:6px;
    color:var(--text);
    font-size:13px;
    padding:8px 12px;
    outline:none;
    cursor:pointer;
  }

  /* EXT OFFLINE BANNER */
  #ext-banner {
    background: rgba(255,77,109,.08);
    border:1px solid rgba(255,77,109,.2);
    border-radius:8px;
    padding:12px 16px;
    margin-bottom:20px;
    font-size:13px;
    color:var(--accent2);
    display:flex;
    align-items:center;
    gap:10px;
  }

  /* RESPONSIVE TABLE WRAPPER */
  .table-wrap { overflow-x:auto; }

  /* MODAL */
  .modal-backdrop {
    position:fixed; inset:0;
    background:rgba(0,0,0,.7);
    backdrop-filter:blur(4px);
    z-index:100;
    display:none;
    align-items:center;
    justify-content:center;
  }
  .modal-backdrop.show { display:flex; }
  .modal {
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:16px;
    padding:28px;
    width:480px;
    max-width:90vw;
  }
  .modal h3 { font-family:'Bebas Neue',sans-serif; font-size:24px; margin-bottom:8px; }
  .modal p { font-size:13px; color:var(--muted); margin-bottom:20px; line-height:1.6; }
  .modal-actions { display:flex; gap:10px; justify-content:flex-end; }

  /* TOOLTIPS */
  [data-tip] { position:relative; cursor:help; }
  [data-tip]::after {
    content: attr(data-tip);
    position:absolute; bottom:calc(100% + 6px); left:50%; transform:translateX(-50%);
    background:#1e2530;
    border:1px solid var(--border);
    color:var(--text);
    font-size:11px;
    padding:5px 10px;
    border-radius:6px;
    white-space:nowrap;
    opacity:0;
    pointer-events:none;
    transition:opacity .15s;
    z-index:50;
  }
  [data-tip]:hover::after { opacity:1; }

  /* SELLER NAME EDIT */
  .seller-edit-wrap { display:flex; align-items:center; gap:8px; }
  .seller-name-input { background:transparent; border:none; color:var(--accent3); font-family:'Space Mono',monospace; font-size:11px; width:120px; outline:none; cursor:pointer; }
  .seller-name-input:focus { border-bottom:1px solid var(--accent3); cursor:text; }

  /* COST SYNC BUTTON */
  .btn-sync-costs {
    background: none;
    color: #60a5fa;
    border: 1px solid rgba(96,165,250,0.4);
    border-radius: 8px;
    padding: 8px 16px;
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all .2s;
    background: rgba(96,165,250,0.08);
  }
  .btn-sync-costs:hover { border-color:#60a5fa; background:rgba(96,165,250,0.15); color:#93c5fd; }
  .btn-sync-costs:disabled { opacity:0.5; cursor:not-allowed; }

  /* COST + PROFIT CELLS */
  .cost-cell { font-family:'Space Mono',monospace; font-size:13px; font-weight:700; color:#e2e8f0; }
  .cost-supplier-tag { display:inline-block; font-size:10px; color:#818cf8; background:rgba(99,102,241,0.12); border:1px solid rgba(99,102,241,0.25); border-radius:4px; padding:1px 6px; margin-top:3px; font-family:'Space Mono',monospace; }
  .profit-pos { color: var(--accent); font-weight:700; font-family:'Space Mono',monospace; font-size:13px; }
  .profit-neg { color: var(--accent2); font-weight:700; font-family:'Space Mono',monospace; font-size:13px; }
  .profit-sub { font-size:10px; color:var(--muted); margin-top:2px; }
  .minmax-cell { font-family:'Space Mono',monospace; font-size:12px; }

  /* SKU INLINE EDIT */
  .sku-display { display:flex; align-items:center; gap:4px; }
  .sku-edit-wrap { display:none; align-items:center; gap:4px; }
  .sku-input { background:var(--surface2); border:1px solid var(--accent); color:var(--text); padding:3px 8px; border-radius:4px; font-size:11px; font-family:'Space Mono',monospace; width:110px; outline:none; }
  .sku-btn { background:none; border:none; cursor:pointer; font-size:11px; padding:2px 6px; border-radius:3px; }

  /* COST NOTIFICATION */
  #costNotify {
    position: fixed;
    bottom: 24px;
    right: 24px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 18px;
    font-size: 13px;
    max-width: 340px;
    z-index: 200;
    display: none;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
  }
  #costNotify.show { display:block; }
  #costNotify.success { border-color: rgba(0,229,160,0.4); color: var(--accent); }
  #costNotify.error { border-color: rgba(255,149,0,0.4); color: var(--accent2); }

  /* CANVAS WRAPPER */
  canvas { display:block; }

  /* SCROLLBAR */
  ::-webkit-scrollbar { width:6px; height:6px; }
  ::-webkit-scrollbar-track { background:var(--bg); }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }
  ::-webkit-scrollbar-thumb:hover { background:var(--muted); }
</style>
</head>
<body>

<div id="app">
  <!-- HEADER -->
  <header>
    <div class="logo">
      <div class="logo-dot"></div>
      MAKRO BUYBOX PRO
    </div>

    <div class="seller-badge">
      MY SELLER: <input id="sellerNameInput" class="seller-name-input" value="BonoloOnline" title="Click to edit your seller name">
    </div>

    <div class="ext-status" id="extStatus">
      <div class="ext-dot" id="extDot"></div>
      <span id="extLabel">Extension offline</span>
    </div>
  </header>

  <!-- NAV -->
  <nav>
    <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
    <button class="tab-btn" onclick="switchTab('products')">üì¶ Products <span class="tab-badge" id="prodCount">0</span></button>
    <button class="tab-btn" onclick="switchTab('scraper')">‚ö° Scraper</button>
    <button class="tab-btn" onclick="switchTab('pricer')">üí∞ Price Updater</button>
    <button class="tab-btn" onclick="switchTab('analytics')">üìà Analytics</button>
    <button class="tab-btn" onclick="switchTab('sync')">üîÑ Sync &amp; Costs</button>
  </nav>

  <!-- MAIN -->
  <main>

    <!-- ========== DASHBOARD TAB ========== -->
    <div class="tab-content active" id="tab-dashboard">

      <div id="extBannerDash" class="empty-state" style="display:none">
        <div class="empty-icon">üîå</div>
        <div class="empty-title">Extension Not Detected</div>
        <div class="empty-text">Install the Makro Pro Scraper Chrome extension to use this dashboard. Waiting for connection...</div>
      </div>

      <div id="dashContent">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Products</div>
            <div class="stat-value accent" id="s-total">0</div>
            <div class="stat-sub">tracked products</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">BuyBox Wins</div>
            <div class="stat-value accent" id="s-wins">0</div>
            <div class="stat-sub" id="s-win-pct">‚Äî% win rate</div>
          </div>
          <div class="stat-card red">
            <div class="stat-label">BuyBox Losses</div>
            <div class="stat-value red" id="s-losses">0</div>
            <div class="stat-sub" id="s-loss-pct">‚Äî% loss rate</div>
          </div>
          <div class="stat-card yellow">
            <div class="stat-label">Last Scraped</div>
            <div class="stat-value yellow" id="s-lastscrape" style="font-size:22px;padding-top:8px">Never</div>
            <div class="stat-sub" id="s-lastscrape-sub"></div>
          </div>
        </div>

        <div class="chart-row">
          <!-- DONUT only on dashboard now ‚Äî status bar moved to Analytics -->
          <div class="card" style="grid-column:1/-1">
            <div class="card-title">Win Rate</div>
            <div class="donut-wrap">
              <canvas class="donut-canvas" id="donutCanvas" width="120" height="120"></canvas>
              <div class="donut-legend">
                <div class="legend-item">
                  <div class="legend-dot" style="background:var(--accent)"></div>
                  <span class="legend-label">Winning</span>
                  <span class="legend-val accent" id="leg-win" style="color:var(--accent)">0</span>
                </div>
                <div class="legend-item">
                  <div class="legend-dot" style="background:var(--accent2)"></div>
                  <span class="legend-label">Losing</span>
                  <span class="legend-val" id="leg-lose" style="color:var(--accent2)">0</span>
                </div>
                <div class="legend-item">
                  <div class="legend-dot" style="background:var(--muted)"></div>
                  <span class="legend-label">Unknown</span>
                  <span class="legend-val" id="leg-unk" style="color:var(--muted)">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- RECENT ACTIVITY -->
        <div class="card">
          <div class="card-title">Recent Activity</div>
          <div id="recentList">
            <div class="empty-state" style="padding:20px">
              <div class="empty-text">No activity yet.</div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /dashboard -->

    <!-- ========== PRODUCTS TAB ========== -->
    <div class="tab-content" id="tab-products">

      <div class="toolbar">
        <input class="filter-input" id="prodSearch" placeholder="üîç Search products..." oninput="renderProducts()">
        <select class="filter-select" id="prodFilter" onchange="renderProducts()">
          <option value="all">All Status</option>
          <option value="win">Winning</option>
          <option value="lose">Losing</option>
          <option value="unknown">Unknown</option>
        </select>
        <div class="toolbar-right">
          <button class="btn-sync-costs" id="syncCostsBtn" onclick="syncCostsFromGSheet()" title="Fetch cost price from Google Sheets by matching SKU">üìä Sync Costs</button>
          <label class="btn-secondary" style="width:auto;padding:8px 16px;cursor:pointer" title="Import your Makro S_listing XLS file">
            üìÇ Import Listings
            <input type="file" id="listingsFileInput" accept=".xls,.xlsx,.csv" style="display:none" onchange="importListings(this)">
          </label>
          <button class="btn-secondary" style="width:auto;padding:8px 16px" onclick="refreshSelected()">‚Üª Refresh Selected</button>
          <button class="btn-secondary danger" style="width:auto;padding:8px 16px;color:#ff9500;border-color:#ff950044" onclick="deleteSelected()">üóë Delete Selected</button>
          <button class="btn-secondary" style="width:auto;padding:8px 16px" onclick="exportCSV()">‚¨á Export CSV</button>
          <button class="btn-secondary" style="width:auto;padding:8px 16px" onclick="clearAllConfirm()">üóë Clear All</button>
        </div>
      </div>

      <div class="table-wrap">
        <table class="product-table">
          <thead>
            <tr>
              <th style="width:32px"><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)" title="Select all"></th>
              <th>Product</th>
              <th>FSN</th>
              <th>SKU</th>
              <th>My Price</th>
              <th>Stock</th>
              <th>Buy Box Price</th>
              <th>Cost Price</th>
              <th>Min Price</th>
              <th>Max Price</th>
              <th>Profit (My Price)</th>
              <th>Seller</th>
              <th>Status</th>
              <th>Last Checked</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="productsBody">
            <tr><td colspan="15">
              <div class="empty-state">
                <div class="empty-icon">üì¶</div>
                <div class="empty-title">No Products Yet</div>
                <div class="empty-text">Paste Makro product URLs in the Scraper tab to get started.</div>
              </div>
            </td></tr>
          </tbody>
        </table>
      </div>
    </div><!-- /products -->

    <!-- ========== SCRAPER TAB ========== -->
    <div class="tab-content" id="tab-scraper">

      <div id="scraperExtBanner" style="display:none" class="empty-state">
        <div class="empty-icon">üîå</div>
        <div class="empty-title">Extension Offline</div>
        <div class="empty-text">The Makro Pro Scraper extension must be installed and enabled. Waiting for connection...</div>
      </div>

      <div id="scraperReady">
        <div class="scraper-layout">
          <div>
            <div class="card-title" style="margin-bottom:10px">PASTE MAKRO PRODUCT URLs</div>
            <textarea id="urlInput" class="url-input-area" placeholder="https://www.makro.co.za/electronics/televisions/p/itmxxxxxxxx
https://www.makro.co.za/appliances/p/itmxxxxxxxx
https://www.makro.co.za/...

One URL per line. Minimum: makro.co.za product pages."></textarea>
            <div style="margin-top:8px; display:flex; justify-content:space-between; align-items:center">
              <span id="urlCount" style="font-size:12px;color:var(--muted)">0 URLs detected</span>
              <button class="action-btn" onclick="clearUrlInput()">Clear</button>
            </div>

            <div class="progress-section" id="progressSection" style="display:none">
              <div class="progress-label">
                <span id="progressText">Scraping...</span>
                <span id="progressPct">0%</span>
              </div>
              <div class="progress-track">
                <div class="progress-fill" id="progressFill" style="width:0%"></div>
              </div>
            </div>

            <div class="scrape-log" id="scrapeLog">
              <div class="log-line"><span class="log-time">&nbsp;</span><span class="log-info">Ready. Paste URLs and click Start Scraping.</span></div>
            </div>
          </div>

          <div class="scraper-config">
            <div class="config-field">
              <label>My Seller Name (for BuyBox detection)</label>
              <input class="config-input" id="sellerNameConfig" placeholder="e.g. BonoloOnline">
            </div>

            <div class="config-field">
              <label>Mode</label>
              <select class="config-input" id="scrapeMode">
                <option value="add">Add / update products</option>
                <option value="replace">Replace all data</option>
              </select>
            </div>

            <div style="padding:14px; background:var(--surface2); border-radius:8px; border:1px solid var(--border)">
              <div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px">Extension Status</div>
              <div style="display:flex; align-items:center; gap:8px; font-size:13px" id="scraperExtStatus">
                <div style="width:8px;height:8px;border-radius:50%;background:var(--muted)" id="scraperDot"></div>
                <span id="scraperExtLabel">Waiting for extension...</span>
              </div>
            </div>

            <button class="btn-primary" id="startBtn" onclick="startScraping()" disabled>
              ‚ö° Start Scraping
            </button>

            <button class="btn-secondary" id="stopBtn" onclick="stopScraping()" style="display:none">
              ‚èπ Stop
            </button>

            <button class="btn-secondary" onclick="loadSampleUrls()">
              üìã Load Sample URLs
            </button>

            <div style="font-size:11px; color:var(--muted); line-height:1.8; padding:12px; background:var(--surface2); border-radius:8px; border:1px solid var(--border)">
              <strong style="color:var(--accent)">‚úÖ Separate window mode ‚Äî bot-free</strong><br>
              1. Paste Makro product URLs (one per line)<br>
              2. A dedicated Chrome window opens automatically<br>
              3. Each page loads as a real foreground tab<br>
              4. Content script scrapes price + seller + FSN<br>
              5. 4‚Äì9 second human delay between pages<br>
              6. Results sync live to your dashboard<br>
              7. Window closes automatically when done
            </div>
          </div>
        </div>
      </div>

    </div><!-- /scraper -->

    <!-- ========== PRICE UPDATER TAB ========== -->
    <div class="tab-content" id="tab-pricer">
      <div class="scraper-layout">
        <!-- LEFT: Settings & Generate -->
        <div>
          <div class="card" style="margin-bottom:16px">
            <div class="card-title" style="margin-bottom:14px">‚öôÔ∏è REPRICING STRATEGY</div>
            <div style="display:grid;gap:12px">
              <label style="font-size:13px;color:var(--muted)">Strategy
                <select id="pricerStrategy" style="width:100%;margin-top:6px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px">
                  <option value="beat">Beat BuyBox by fixed amount</option>
                  <option value="match">Match BuyBox exactly</option>
                  <option value="pct">Beat BuyBox by percentage</option>
                  <option value="floor">Beat BuyBox but never below my floor price</option>
                </select>
              </label>
              <label style="font-size:13px;color:var(--muted)">Beat by (R amount or %)
                <input id="pricerBeatBy" type="number" value="1" min="0" step="0.50" style="width:100%;margin-top:6px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px">
              </label>
              <label style="font-size:13px;color:var(--muted)">Floor price margin (% above cost ‚Äî only used in floor strategy)
                <input id="pricerFloor" type="number" value="10" min="0" step="1" style="width:100%;margin-top:6px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:13px">
              </label>

              <!-- Min / Max price guards ‚Äî apply to ALL strategies -->
              <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-top:2px">
                <div style="font-size:11px;color:var(--accent);font-weight:700;letter-spacing:1px;margin-bottom:10px">üõ° PRICE GUARDS ‚Äî applies to every strategy</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
                  <label style="font-size:12px;color:var(--muted)">
                    Min Price (R) ‚Äî never go below
                    <div style="display:flex;align-items:center;gap:6px;margin-top:5px">
                      <label style="font-size:11px;display:flex;align-items:center;gap:4px;cursor:pointer">
                        <input type="checkbox" id="pricerMinEnabled" onchange="buildPricerPreview()" style="width:14px;height:14px"> On
                      </label>
                      <input id="pricerMinPrice" type="number" value="0" min="0" step="1"
                        style="flex:1;background:var(--surface);border:1px solid var(--border);color:var(--text);padding:6px;border-radius:5px;font-size:12px"
                        oninput="buildPricerPreview()">
                    </div>
                  </label>
                  <label style="font-size:12px;color:var(--muted)">
                    Max Price (R) ‚Äî never go above
                    <div style="display:flex;align-items:center;gap:6px;margin-top:5px">
                      <label style="font-size:11px;display:flex;align-items:center;gap:4px;cursor:pointer">
                        <input type="checkbox" id="pricerMaxEnabled" onchange="buildPricerPreview()" style="width:14px;height:14px"> On
                      </label>
                      <input id="pricerMaxPrice" type="number" value="9999" min="0" step="1"
                        style="flex:1;background:var(--surface);border:1px solid var(--border);color:var(--text);padding:6px;border-radius:5px;font-size:12px"
                        oninput="buildPricerPreview()">
                    </div>
                  </label>
                </div>
                <div style="font-size:10px;color:var(--muted);margin-top:8px;line-height:1.5">
                  Products clamped to min/max will show <span style="color:#ff9500">‚ö† CLAMPED</span> in the preview and be skipped from the upload to avoid pricing mistakes.
                </div>
              </div>

              <label style="font-size:13px;display:flex;align-items:center;gap:8px;color:var(--muted);cursor:pointer">
                <input type="checkbox" id="pricerWinsOnly" checked style="width:16px;height:16px">
                Only update products where I'm losing the BuyBox
              </label>
              <label style="font-size:13px;display:flex;align-items:center;gap:8px;color:var(--muted);cursor:pointer">
                <input type="checkbox" id="pricerSkipUnknown" checked style="width:16px;height:16px">
                Skip products with no BuyBox price scraped yet
              </label>
            </div>
          </div>

          <div class="card">
            <div class="card-title" style="margin-bottom:14px">üìã LISTINGS FILE REQUIRED</div>
            <p style="font-size:12px;color:var(--muted);margin-bottom:12px">Import your S_listing XLS first (Products tab ‚Üí Import Listings). The price updater uses your current prices and FSN codes to generate the upload file.</p>
            <div id="pricerListingsStatus" style="font-size:13px;color:var(--muted);margin-bottom:16px">‚è≥ Checking listings...</div>
          <button class="btn-primary" onclick="generatePriceUpdate()" id="generateBtn" style="width:100%;margin-bottom:8px">‚¨á Generate & Download Price Update File</button>
          <button class="btn-secondary" onclick="openPortalUpload()" id="portalUploadBtn" style="width:100%;display:none">üöÄ Open Seller Portal ‚Äî Auto Upload</button>
            <div id="pricerResult" style="margin-top:14px;font-size:12px;color:var(--muted)"></div>
          </div>
        </div>

        <!-- RIGHT: Preview table -->
        <div class="card" style="overflow:auto">
          <div class="card-title" style="margin-bottom:14px">üëÅ PREVIEW ‚Äî Products to Update</div>
          <div id="pricerPreview" style="font-size:12px;color:var(--muted)">Generate a file to see preview here.</div>
        </div>
      </div>

      <!-- How to upload instructions -->
      <div class="card" style="margin-top:16px">
        <div class="card-title" style="margin-bottom:10px">üì§ HOW TO UPLOAD TO SELLER PORTAL</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px">
          <div style="text-align:center;padding:12px">
            <div style="font-size:24px;margin-bottom:8px">1Ô∏è‚É£</div>
            <div style="font-size:12px;color:var(--muted)">Click <b style="color:var(--text)">Generate Price Update File</b> above to download your updated XLS</div>
          </div>
          <div style="text-align:center;padding:12px">
            <div style="font-size:24px;margin-bottom:8px">2Ô∏è‚É£</div>
            <div style="font-size:12px;color:var(--muted)">Go to <b style="color:var(--accent)">seller.makro.co.za</b> ‚Üí <b style="color:var(--text)">Products</b> ‚Üí <b style="color:var(--text)">Update Products</b></div>
          </div>
          <div style="text-align:center;padding:12px">
            <div style="font-size:24px;margin-bottom:8px">3Ô∏è‚É£</div>
            <div style="font-size:12px;color:var(--muted)">Upload the generated XLS file using <b style="color:var(--text)">Bulk Upload</b></div>
          </div>
          <div style="text-align:center;padding:12px">
            <div style="font-size:24px;margin-bottom:8px">4Ô∏è‚É£</div>
            <div style="font-size:12px;color:var(--muted)">Prices update within <b style="color:var(--text)">15‚Äì30 minutes</b> on Makro marketplace</div>
          </div>
        </div>
      </div>
    </div><!-- /pricer -->

    <!-- ========== ANALYTICS TAB ========== -->
    <div class="tab-content" id="tab-analytics">
      <div class="analytics-grid">

        <!-- ROW 1: Price dist + Trend -->
        <div class="card">
          <div class="card-title">Price Distribution</div>
          <canvas id="priceChart" height="180"></canvas>
          <div id="emptyPriceChart" class="empty-state" style="padding:20px; display:none">
            <div class="empty-text">No data yet</div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Win/Loss Over Time</div>
          <canvas id="trendChart" height="180"></canvas>
          <div id="emptyTrendChart" class="empty-state" style="padding:20px; display:none">
            <div class="empty-text">Scrape products to see trends</div>
          </div>
        </div>

        <!-- ROW 2: Status bar chart (was missing from HTML) -->
        <div class="card analytics-full">
          <div class="card-title" style="margin-bottom:14px">üìä All Products ‚Äî BuyBox Price vs Status</div>
          <div id="statusBarChartAnalytics" style="max-height:400px;overflow-y:auto"></div>
        </div>

        <!-- ROW 3: Competitor full breakdown + price gap analysis -->
        <div class="card">
          <div class="card-title" style="margin-bottom:14px">üèÜ Competitor Breakdown</div>
          <div id="compBreakdown"></div>
        </div>

        <div class="card">
          <div class="card-title" style="margin-bottom:14px">üìâ Price Gap Analysis</div>
          <div id="priceGapAnalysis"></div>
        </div>

        <!-- ROW 4: Price comparison bar (was missing) -->
        <div class="card analytics-full">
          <div class="card-title" style="margin-bottom:10px">üí∞ BuyBox Price Comparison</div>
          <div id="priceCompBar" class="bar-chart" style="max-height:320px;overflow-y:auto"></div>
          <div id="emptyPriceComp" class="empty-state" style="padding:20px;display:none">
            <div class="empty-text">No price data yet</div>
          </div>
        </div>

        <!-- ROW 5: Opportunity table + Summary -->
        <div class="card analytics-full">
          <div class="card-title" style="margin-bottom:14px">üéØ Top Opportunities ‚Äî Closest to Winning BuyBox</div>
          <div id="opportunityTable" style="overflow-x:auto"></div>
        </div>

        <div class="card">
          <div class="card-title" style="margin-bottom:14px">üìã Summary Stats</div>
          <div id="summaryStats" style="display:flex; flex-direction:column; gap:4px; padding-top:4px"></div>
        </div>

      </div>
    </div><!-- /analytics -->

    <!-- ========== SYNC & COSTS TAB ========== -->
    <div class="tab-content" id="tab-sync">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">

        <!-- LEFT: GitHub Gist Sync -->
        <div class="card">
          <div class="card-title" style="margin-bottom:14px">üîÑ GITHUB GIST SYNC ‚Äî Auto Sync Both PCs</div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:14px;line-height:1.7">
            Syncs all your products between home &amp; work PC via a private GitHub Gist. Set up once ‚Äî auto-syncs every 5 minutes in the background.
          </div>
          <div style="display:grid;gap:10px;margin-bottom:14px">
            <label style="font-size:12px;color:var(--muted)">GitHub Token (ghp_...)
              <input id="gistTokenInput" type="password" placeholder="ghp_xxxxxxxxxxxxx"
                style="width:100%;margin-top:5px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:12px;font-family:monospace"
                oninput="localStorage.setItem('gist_token',this.value)">
            </label>
            <label style="font-size:12px;color:var(--muted)">Gist ID
              <span style="color:var(--muted);font-size:10px"> ‚Äî leave blank on first push, it creates one automatically</span>
              <input id="gistIdInput" type="text" placeholder="paste Gist ID from home PC here..."
                style="width:100%;margin-top:5px;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:12px;font-family:monospace"
                oninput="localStorage.setItem('gist_id',this.value)">
            </label>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
            <button class="btn-primary" onclick="gistPush()" style="padding:10px;font-size:12px">‚¨Ü Push to Gist</button>
            <button class="btn-secondary" onclick="gistPull(false)" style="padding:10px;font-size:12px">‚¨á Pull from Gist</button>
          </div>
          <div id="gistIdRow" style="display:none;align-items:center;gap:8px;margin-bottom:10px;background:rgba(0,229,160,0.08);border:1px solid rgba(0,229,160,0.2);border-radius:6px;padding:10px">
            <span style="font-size:11px;color:var(--muted)">Your Gist ID ‚Äî paste this on your other PC:</span>
            <code id="gistIdDisplay" style="color:var(--accent);font-size:12px;flex:1;word-break:break-all"></code>
            <button onclick="navigator.clipboard.writeText(document.getElementById('gistIdDisplay').textContent)"
              style="background:none;border:1px solid var(--accent);color:var(--accent);padding:3px 8px;border-radius:4px;font-size:10px;cursor:pointer">Copy</button>
          </div>
          <div id="gistStatus" style="font-size:12px;color:var(--muted);min-height:20px"></div>
          <div id="gistLastSync" style="font-size:10px;color:var(--muted);margin-top:4px"></div>
          <div style="margin-top:14px;font-size:11px;color:var(--muted);line-height:1.9;background:var(--surface2);border-radius:6px;padding:12px">
            <b style="color:var(--accent3)">One-time setup:</b><br>
            1. Paste your GitHub token (needs <b>gist</b> scope only)<br>
            2. <b>Home PC:</b> click Push ‚Üí copy the Gist ID shown<br>
            3. <b>Work PC:</b> same token + paste Gist ID ‚Üí Pull<br>
            4. ‚úÖ Both PCs auto-sync every 5 minutes
          </div>
        </div>

        <!-- RIGHT: Google Sheet Cost Importer -->
        <div class="card">
          <div class="card-title" style="margin-bottom:14px">üí∞ SUPPLIER COST IMPORTER ‚Äî Google Sheet</div>
          <div style="font-size:12px;color:var(--muted);margin-bottom:12px;line-height:1.7">
            Reads your supplier Google Sheet. <b style="color:var(--text)">SKU must be in Column A</b> on every tab. Cost column differs per tab ‚Äî you pick it. Matches SKU to your Makro products and sets Min Price automatically.
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:12px">
            <button class="btn-primary" onclick="loadSheetTabs()" style="padding:10px;font-size:12px">
              üìä Load Known Tabs
            </button>
            <button class="btn-secondary" onclick="syncCostsFromGSheet()" style="padding:10px;font-size:12px" id="syncCostsBtn2">
              ‚ö° Quick Sync All
            </button>
          </div>

          <div id="costTabSelector" style="margin-bottom:10px"></div>

          <!-- Manual tab name entry -->
          <div style="font-size:11px;color:var(--muted);margin-bottom:6px">Enter any supplier tab name to preview & import:</div>
          <div style="display:flex;gap:8px;margin-bottom:10px">
            <input id="manualTabName" placeholder="e.g. Kolok, Rectron, Pinnacle..."
              style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px 10px;border-radius:6px;font-size:12px">
            <button class="btn-secondary" style="width:auto;padding:7px 14px;font-size:12px"
              onclick="previewTab(document.getElementById('manualTabName').value)">Preview</button>
          </div>

          <div id="costColumnPicker" style="display:none;margin-bottom:12px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px"></div>
          <div id="costStatus" style="font-size:12px;color:var(--muted);min-height:20px;line-height:1.6"></div>

          <div style="margin-top:12px;font-size:11px;color:var(--muted);background:var(--surface2);border-radius:6px;padding:10px;line-height:1.8">
            <b style="color:var(--accent3)">How it works:</b><br>
            1. Import your Makro Offers file on the <b>Products tab</b> ‚Äî this loads SKUs<br>
            2. Type a supplier tab name above ‚Üí Preview ‚Üí Import<br>
            3. Or click <b>Quick Sync All</b> to auto-match all known tabs at once<br>
            4. Cost price auto-populates on matched products + sets Min Price guard
          </div>
        </div>

      </div>

      <!-- Cost coverage table -->
      <div class="card">
        <div class="card-title" style="margin-bottom:12px">üìã COST COVERAGE ‚Äî Products with supplier cost data</div>
        <div id="costCoverageTable"><div style="color:var(--muted);font-size:12px;padding:10px">Load supplier sheet above to populate costs.</div></div>
      </div>
    </div><!-- /sync -->

  </main>
</div>

<!-- COST SYNC NOTIFICATION -->
<div id="costNotify"></div>

<!-- CLEAR CONFIRM MODAL -->
<div class="modal-backdrop" id="clearModal">
  <div class="modal">
    <h3>‚ö†Ô∏è Clear All Products?</h3>
    <p>This will permanently delete all <span id="clearCount">0</span> scraped products from local storage. This cannot be undone.</p>
    <div class="modal-actions">
      <button class="btn-secondary" style="width:auto" onclick="document.getElementById('clearModal').classList.remove('show')">Cancel</button>
      <button class="btn-primary" style="width:auto;background:var(--accent2)" onclick="clearAll()">Delete All</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
const STORAGE_KEY = 'makro_buybox_v2';
const SELLER_KEY  = 'makro_seller_name';

let state = {
  products: [],     // [{url, fsn, title, buybox_price, seller, status, lastChecked, history:[]}]
  scraping: false,
  extReady: false,
  stopRequested: false,
};

let extensionId = null;

// ============================================================
// STORAGE
// ============================================================
function saveProducts() {
  try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state.products)); } catch(e) {}
}

function loadProducts() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) state.products = JSON.parse(raw);
  } catch(e) { state.products = []; }
}

function getMySellerName() {
  return document.getElementById('sellerNameInput').value.trim() || 'BonoloOnline';
}

function reEvaluateStatuses() {
  const myName = getMySellerName().toLowerCase().trim();
  state.products.forEach(function(p) {
    if (!p.seller || p.seller === 'Unknown Seller') {
      p.status = 'unknown';
    } else {
      const s = p.seller.toLowerCase();
      p.status = (s.includes(myName) || myName.includes(s.substring(0,6))) ? 'win' : 'lose';
    }
    // ‚îÄ‚îÄ MIGRATE FSN from URL if missing ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Products scraped before FSN fix: try to extract FSN from stored URL now
    if (!p.fsn && p.url) {
      // Try pid= param
      const m1 = p.url.match(/[?&]pid=([A-Z0-9]{8,})/i);
      if (m1) { p.fsn = m1[1].toUpperCase(); return; }
      // Try to match SKU-like path segment that looks like a Makro FSN (uppercase alpha+numeric, 12-20 chars)
      // Makro FSNs look like: INTH5YY5BCERERBG, PRNH5FQYEF7HS9SE
      const m2 = p.url.match(/\/([A-Z]{2,4}[A-Z0-9]{8,16})(?:[/?#]|$)/);
      if (m2 && /^[A-Z]{2,4}[A-Z0-9]+$/.test(m2[1])) p.fsn = m2[1];
    }
  });
}

// ============================================================
// EXTENSION BRIDGE
// ============================================================
// This page is loaded directly (not inside an iframe!)
// So the extension-bridge.js injects and postMessages directly to window.

window.addEventListener('message', function(ev) {
  var d = ev.data;
  if (!d || !d.type) return;

  if (d.type === 'MAKRO_EXTENSION_READY') {
    if (!state.extReady) {
      state.extReady = true;
      extensionId = d.extensionId || null;
      log('info', 'Extension connected' + (extensionId ? ' (id: ' + extensionId.slice(0,8) + '...)' : ''));
    }
    setExtStatus(true);
    return;
  }

  if (d.type === 'PRODUCTS_UPDATED') {
    loadProducts();
    reEvaluateStatuses();
    saveProducts();
    updateProductCount();
    renderDashboard();
    const anyChecked = document.querySelectorAll('.row-check:checked').length > 0;
    if (!anyChecked) renderProducts();
    return;
  }

  if (d.type === 'SCRAPE_RESULT') {
    // legacy ‚Äî no longer used in human-mode but kept for compat
    return;
  }

  if (d.type === 'QUEUE_PROGRESS') {
    handleQueueProgress(d);
    return;
  }

  if (d.type === 'QUEUE_FINISHED') {
    handleQueueFinished();
    return;
  }

  if (d.type === 'QUEUE_ABORTED') {
    log('info', '‚ö† Queue stopped ‚Äî tab was closed. ' + (d.done||0) + '/' + (d.total||0) + ' done.');
    finishScraping();
    return;
  }
});

// Also check via chrome.runtime if available (same page)
function pingExtension() {
  // We rely on extension-bridge.js announcing via postMessage
  // but also request on load
  try {
    window.postMessage({ type: 'REQUEST_EXTENSION' }, '*');
  } catch(e) {}
}

// ============================================================
// EXT STATUS UI
// ============================================================
function setExtStatus(online) {
  state.extReady = online;
  document.getElementById('extDot').className = 'ext-dot ' + (online ? 'green' : 'red');
  document.getElementById('extLabel').textContent = online ? 'Extension connected' : 'Extension offline';
  document.getElementById('scraperDot').style.background = online ? 'var(--accent)' : 'var(--muted)';
  document.getElementById('scraperExtLabel').textContent = online ? '‚úì Connected ‚Äî ready to scrape' : 'Waiting for extension...';
  document.getElementById('startBtn').disabled = !online;
  document.getElementById('scraperExtBanner').style.display = online ? 'none' : 'block';
  document.getElementById('scraperReady').style.display = 'flex';
  document.getElementById('scraperReady').style.flexDirection = online ? '' : 'none';
  // Show scraper layout regardless; just disable the button
  document.getElementById('scraperReady').style.display = 'block';
}

// ============================================================
// TABS
// ============================================================
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => {
    const match = (b.getAttribute('onclick') || '').includes("'" + name + "'");
    b.classList.toggle('active', match);
  });
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  const tabEl = document.getElementById('tab-' + name);
  if (tabEl) tabEl.classList.add('active');
  if (name === 'dashboard') renderDashboard();
  if (name === 'products')  renderProducts();
  if (name === 'analytics') renderAnalytics();
  if (name === 'scraper')   syncSellerConfig();
  if (name === 'pricer')    initPricer();
  if (name === 'sync')      initSyncTab();
}

function syncSellerConfig() {
  document.getElementById('sellerNameConfig').value = getMySellerName();
}

// ============================================================
// SCRAPER ‚Äî Human-mode queue (bot-free)
// Opens each URL as a real foreground tab, content.js auto-scrapes,
// background.js advances the queue. No background/hidden tabs.
// ============================================================
let scrapeQueue = [];
let scrapeIdx   = 0;

function parseUrls() {
  const raw = document.getElementById('urlInput').value;
  return raw.split('\n')
    .map(l => l.trim())
    .filter(l => l.startsWith('http') && l.includes('makro.co.za'));
}

document.getElementById('urlInput').addEventListener('input', function() {
  const urls = parseUrls();
  document.getElementById('urlCount').textContent = urls.length + ' URL' + (urls.length !== 1 ? 's' : '') + ' detected';
});

function clearUrlInput() {
  document.getElementById('urlInput').value = '';
  document.getElementById('urlCount').textContent = '0 URLs detected';
}

function startScraping() {
  if (!state.extReady) { alert('Extension not connected. Please install the Makro Pro Scraper extension.'); return; }
  const urls = parseUrls();
  if (urls.length === 0) { alert('No valid Makro URLs found. Paste at least one makro.co.za product URL.'); return; }

  const configSeller = document.getElementById('sellerNameConfig').value.trim();
  if (configSeller) document.getElementById('sellerNameInput').value = configSeller;

  scrapeQueue = [...urls];
  scrapeIdx   = 0;
  state.scraping = true;
  state.stopRequested = false;

  document.getElementById('startBtn').style.display = 'none';
  document.getElementById('stopBtn').style.display  = 'flex';
  document.getElementById('progressSection').style.display = 'block';
  clearLog();
  log('info', 'üöÄ Human-mode queue started: ' + urls.length + ' URLs');
  log('info', 'Each product page will open in a foreground tab ‚Äî fully bot-free.');
  log('info', 'Seller: ' + getMySellerName());

  updateProgress(0, urls.length);

  // Send queue to background service worker
  window.postMessage({ type: 'START_QUEUE', urls: urls }, '*');
}

function stopScraping() {
  state.stopRequested = true;
  state.scraping = false;
  window.postMessage({ type: 'STOP_QUEUE' }, '*');
  finishScraping();
  log('info', '‚èπ Scraping stopped.');
}

// Called by bridge when background reports a page was scraped
function handleQueueProgress(d) {
  scrapeIdx++;
  updateProgress(scrapeIdx, scrapeQueue.length);

  if (d && d.data) {
    const p  = d.data;
    const seller = p.buyBoxSeller || 'Unknown Seller';
    const price  = parseFloat(p.buyBoxPrice) || 0;
    const myName = getMySellerName().toLowerCase().trim();
    const isWin  = seller !== 'Unknown Seller' &&
                   (seller.toLowerCase().includes(myName) || myName.includes(seller.toLowerCase().substring(0,6)));
    const status = seller === 'Unknown Seller' ? 'unknown' : (isWin ? 'win' : 'lose');

    const existing = state.products.find(function(x) {
      return x.url === p.url || (p.fsn && x.fsn === p.fsn);
    });
    if (existing) {
      existing.buybox_price = price;
      existing.seller       = seller;
      existing.status       = status;
      existing.lastChecked  = new Date().toISOString();
      existing.title        = p.title || existing.title;
      existing.fsn          = p.fsn || existing.fsn || '';
      // Never overwrite a real SKU with null/itm slug from scraper
      if (p.sku && !p.sku.startsWith('itm')) existing.sku = p.sku;
      existing.history      = existing.history || [];
      existing.history.push({ price, seller, status, ts: new Date().toISOString() });
      if (existing.history.length > 30) existing.history.shift();
    } else {
      // Don't store itm... slugs as SKU ‚Äî real SKU comes from listings import
      const realSku = (p.sku && !p.sku.startsWith('itm')) ? p.sku : '';
      state.products.push({
        url: p.url, fsn: p.fsn || '', sku: realSku,
        title: p.title || p.url, buybox_price: price,
        seller, status, lastChecked: new Date().toISOString(),
        history: [{ price, seller, status, ts: new Date().toISOString() }]
      });
    }
    saveProducts();
    log(isWin ? 'ok' : 'err',
      (isWin ? '‚úì WIN ' : '‚úó LOSE') + ' | R' + price.toFixed(2) + ' | ' + seller.slice(0,30) +
      ' | ' + (p.title||'').slice(0,35));
  }

  if (scrapeIdx >= scrapeQueue.length) finishScraping();
}

function handleQueueFinished() {
  finishScraping();
  log('ok', '‚úÖ Queue complete ‚Äî all products scraped.');
}

function finishScraping() {
  state.scraping      = false;
  state.stopRequested = false;
  document.getElementById('startBtn').style.display = 'flex';
  document.getElementById('stopBtn').style.display  = 'none';
  updateProgress(scrapeQueue.length, scrapeQueue.length);
  renderDashboard();
  renderProducts();
  updateProductCount();
}

function handleBulkResults(d) { /* legacy compat */ }

// ============================================================
// PROGRESS + LOG
// ============================================================
function updateProgress(current, total) {
  const pct = total > 0 ? Math.round((current / total) * 100) : 0;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressPct').textContent = pct + '%';
  document.getElementById('progressText').textContent = 'Scraping ' + current + ' / ' + total;
}

function log(type, msg) {
  const el = document.getElementById('scrapeLog');
  const now = new Date().toTimeString().slice(0,8);
  const line = document.createElement('div');
  line.className = 'log-line';
  line.innerHTML = '<span class="log-time">' + now + '</span><span class="log-' + type + '">' + escHtml(msg) + '</span>';
  el.appendChild(line);
  el.scrollTop = el.scrollHeight;
}

function clearLog() {
  document.getElementById('scrapeLog').innerHTML = '';
}

function shortUrl(url) {
  try { return new URL(url).pathname.split('/').filter(Boolean).pop() || url; } catch(e) { return url; }
}

function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ============================================================
// DASHBOARD
// ============================================================
function renderDashboard() {
  const prods = state.products;
  const wins = prods.filter(p => p.status === 'win').length;
  const loses = prods.filter(p => p.status === 'lose').length;
  const unk = prods.filter(p => p.status === 'unknown' || !p.status).length;
  const total = prods.length;
  const winPct = total > 0 ? Math.round((wins/total)*100) : 0;

  document.getElementById('s-total').textContent = total;
  document.getElementById('s-wins').textContent = wins;
  document.getElementById('s-losses').textContent = loses;
  document.getElementById('s-win-pct').textContent = winPct + '% win rate';
  document.getElementById('s-loss-pct').textContent = total > 0 ? Math.round((loses/total)*100) + '% loss rate' : '‚Äî% loss rate';

  const lastScrape = localStorage.getItem('makro_last_scrape');
  if (lastScrape) {
    const d = new Date(lastScrape);
    document.getElementById('s-lastscrape').textContent = d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
    document.getElementById('s-lastscrape-sub').textContent = d.toLocaleDateString();
  }

  // Donut
  drawDonut(wins, loses, unk);
  document.getElementById('leg-win').textContent = wins;
  document.getElementById('leg-lose').textContent = loses;
  document.getElementById('leg-unk').textContent = unk;

  // Recent activity
  const recents = [...prods]
    .filter(p => p.lastChecked)
    .sort((a,b) => new Date(b.lastChecked) - new Date(a.lastChecked))
    .slice(0, 8);

  const recentEl = document.getElementById('recentList');
  if (recents.length === 0) {
    recentEl.innerHTML = '<div class="empty-state" style="padding:20px"><div class="empty-text">No activity yet.</div></div>';
  } else {
    recentEl.innerHTML = recents.map(p => {
      const color = p.status === 'win' ? 'var(--accent)' : p.status === 'lose' ? 'var(--accent2)' : 'var(--muted)';
      const icon = p.status === 'win' ? '‚úì' : p.status === 'lose' ? '‚úó' : '?';
      const t = new Date(p.lastChecked).toLocaleString();
      return `<div style="display:flex;align-items:center;gap:14px;padding:10px 0;border-bottom:1px solid var(--border)">
        <div style="width:26px;height:26px;border-radius:50%;background:${color};color:#000;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;flex-shrink:0">${icon}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escHtml(p.title||p.url)}</div>
          <div style="font-size:11px;color:var(--muted)">${escHtml(p.seller||'?')} ¬∑ ${t}</div>
        </div>
        <div style="font-family:'Space Mono',monospace;font-size:13px;font-weight:700;color:${color}">R${(p.buybox_price||0).toFixed(2)}</div>
      </div>`;
    }).join('');
  }
}

function drawDonut(wins, loses, unk) {
  const canvas = document.getElementById('donutCanvas');
  const ctx = canvas.getContext('2d');
  const W = 120, H = 120, cx = 60, cy = 60, r = 44, stroke = 16;
  ctx.clearRect(0,0,W,H);

  const total = wins + loses + unk || 1;
  const slices = [
    { val: wins, color: '#00e5a0' },
    { val: loses, color: '#ff4d6d' },
    { val: unk, color: '#6b7280' },
  ];

  let start = -Math.PI / 2;
  slices.forEach(s => {
    if (s.val === 0) return;
    const angle = (s.val / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.arc(cx, cy, r, start, start + angle);
    ctx.strokeStyle = s.color;
    ctx.lineWidth = stroke;
    ctx.stroke();
    start += angle;
  });

  // Center text
  ctx.fillStyle = '#e8eaf0';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.font = 'bold 18px "Bebas Neue", sans-serif';
  ctx.fillText(Math.round((wins/total)*100) + '%', cx, cy - 6);
  ctx.font = '10px "DM Sans", sans-serif';
  ctx.fillStyle = '#6b7280';
  ctx.fillText('win rate', cx, cy + 10);
}

// ============================================================
// PRODUCTS
// ============================================================
function renderProducts() {
  const search = (document.getElementById('prodSearch').value || '').toLowerCase();
  const filter = document.getElementById('prodFilter').value;

  // ‚îÄ‚îÄ PRESERVE checked state before re-render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const prevChecked = new Set();
  document.querySelectorAll('.row-check:checked').forEach(c => prevChecked.add(parseInt(c.dataset.idx)));

  // Load listings cross-reference map
  const listingsMap = {};
  try {
    const raw = localStorage.getItem('makro_listings');
    if (raw) JSON.parse(raw).forEach(l => { listingsMap[l.fsn] = l; });
  } catch(e) {}

  let prods = state.products.filter(p => {
    if (filter === 'win' && p.status !== 'win') return false;
    if (filter === 'lose' && p.status !== 'lose') return false;
    if (filter === 'unknown' && p.status !== 'unknown' && p.status) return false;
    const titleOk = (p.title||'').toLowerCase().includes(search);
    const sellerOk = (p.seller||'').toLowerCase().includes(search);
    const fsnOk = (p.fsn||'').toLowerCase().includes(search);
    const skuOk = (p.sku||'').toLowerCase().includes(search);
    if (search && !titleOk && !sellerOk && !fsnOk && !skuOk) return false;
    return true;
  });

  const tbody = document.getElementById('productsBody');
  if (prods.length === 0) {
    tbody.innerHTML = `<tr><td colspan="15"><div class="empty-state">
      <div class="empty-icon">üì¶</div>
      <div class="empty-title">${state.products.length === 0 ? 'No Products Yet' : 'No Matches'}</div>
      <div class="empty-text">${state.products.length === 0 ? 'Use the Scraper tab to add products.' : 'Try changing your filters.'}</div>
    </div></td></tr>`;
    return;
  }

  tbody.innerHTML = prods.map((p, i) => {
    const statusClass = p.status === 'win' ? 'win' : p.status === 'lose' ? 'lose' : 'unknown';
    const statusLabel = p.status === 'win' ? '‚úì WIN' : p.status === 'lose' ? '‚úó LOSE' : '? UNKNOWN';
    const t = p.lastChecked ? new Date(p.lastChecked).toLocaleString() : '‚Äî';
    const realIdx = state.products.indexOf(p);
    const listing = listingsMap[p.fsn] || null;

    // ‚îÄ‚îÄ My Price & Stock from listings ‚îÄ‚îÄ
    const myPriceVal = listing ? listing.myPrice : (p.myPrice || null);
    const myStock = listing ? `<span style="color:${listing.myStock > 0 ? 'var(--accent)' : '#ff9500'};font-size:12px">${listing.myStock}</span>` : '<span style="color:var(--muted);font-size:11px">‚Äî</span>';
    let priceIndicator = '';
    if (myPriceVal && p.buybox_price > 0) {
      if (myPriceVal > p.buybox_price) priceIndicator = ' <span style="color:#ff9500;font-size:10px">‚ñ≤above</span>';
      else if (myPriceVal < p.buybox_price) priceIndicator = ' <span style="color:var(--accent);font-size:10px">‚ñºbelow</span>';
      else priceIndicator = ' <span style="color:var(--muted);font-size:10px">=match</span>';
    }
    const myPriceHtml = myPriceVal
      ? `<span style="color:var(--accent3);font-family:'Space Mono',monospace;font-size:12px">R ${myPriceVal.toFixed(2)}</span>${priceIndicator}`
      : '<span style="color:var(--muted);font-size:11px">‚Äî</span>';

    // ‚îÄ‚îÄ FSN display ‚îÄ‚îÄ
    const fsnVal = escHtml(p.fsn || '‚Äî');
    const fsnHtml = `<div style="font-family:'Space Mono',monospace;font-size:11px;color:var(--muted)">${fsnVal}</div>`;

    // ‚îÄ‚îÄ SKU display ‚Äî from listings import, needed for cost sync ‚îÄ‚îÄ
    const skuVal  = escHtml(p.sku || '');
    const skuHtml = skuVal
      ? `<div style="font-family:'Space Mono',monospace;font-size:12px;color:#818cf8;font-weight:600">${skuVal}</div>`
      : `<div style="font-size:10px;color:var(--muted)">‚Äî import listings</div>`;

    // ‚îÄ‚îÄ Cost price ‚Äî inline editable ‚îÄ‚îÄ
    const cost = p.cost_price ? Number(p.cost_price) : null;
    const costDisplay = cost ? `R ${cost.toFixed(2)}` : '‚Äî';
    const costHtml = `
      <div class="sku-display" id="cost-disp-${realIdx}" style="display:flex;align-items:center;gap:4px">
        <span class="${cost ? 'cost-cell' : ''}" style="${!cost ? 'color:var(--muted);font-size:11px' : ''}">${costDisplay}</span>
        ${p.cost_supplier ? `<div class="cost-supplier-tag">${escHtml(p.cost_supplier)}</div>` : ''}
        <button class="sku-btn" onclick="editCost(${realIdx})" title="Edit cost price" style="color:var(--muted);font-size:11px">‚úè</button>
      </div>
      <div class="sku-edit-wrap" id="cost-edit-${realIdx}" style="display:none;align-items:center;gap:4px">
        <input class="sku-input" id="cost-inp-${realIdx}" value="${cost ? cost.toFixed(2) : ''}" placeholder="0.00" type="number" step="0.01" min="0"
          onkeydown="if(event.key==='Enter')saveCost(${realIdx});if(event.key==='Escape')cancelCost(${realIdx})" style="width:90px">
        <button class="sku-btn" onclick="saveCost(${realIdx})" style="color:var(--accent)">‚úì</button>
        <button class="sku-btn" onclick="cancelCost(${realIdx})" style="color:var(--muted)">‚úï</button>
      </div>`;

    // ‚îÄ‚îÄ Min / Max price ‚îÄ‚îÄ
    const minP = p.min_price ? Number(p.min_price) : null;
    const maxP = p.max_price ? Number(p.max_price) : null;
    const minHtml = minP
      ? `<span class="minmax-cell" style="color:#34d399">R ${minP.toFixed(2)}</span>`
      : `<span style="color:var(--muted);font-size:11px">‚Äî</span>`;
    const maxHtml = maxP
      ? `<span class="minmax-cell" style="color:#f59e0b">R ${maxP.toFixed(2)}</span>`
      : `<span style="color:var(--muted);font-size:11px">‚Äî</span>`;

    // ‚îÄ‚îÄ Profit calculation: 10% Makro commission + tiered delivery ‚îÄ‚îÄ
    let profitHtml = '<span style="color:var(--muted);font-size:11px">‚Äî</span>';
    const priceForCalc = myPriceVal || (p.buybox_price ? Number(p.buybox_price) : null);
    if (cost && priceForCalc) {
      const fees   = makroFees(priceForCalc);
      const profit = priceForCalc - fees.total - cost;
      const margin = ((profit / priceForCalc) * 100).toFixed(1);
      const cls    = profit >= 0 ? 'profit-pos' : 'profit-neg';
      const label  = myPriceVal ? 'My Price' : 'BuyBox';
      profitHtml   = `<div class="${cls}">${profit >= 0 ? '+' : ''}R ${Math.abs(profit).toFixed(2)}</div>
        <div class="profit-sub">10% (R${fees.commission.toFixed(0)}) + del R${fees.delivery} ¬∑ ${margin}% ¬∑ ${label}</div>`;
    }

    return `<tr>
      <td><input type="checkbox" class="row-check" data-idx="${realIdx}"></td>
      <td>
        <div class="prod-title">${escHtml((p.title||'Unknown').slice(0,55))}</div>
        <a class="prod-url" href="${escHtml(p.url)}" target="_blank" rel="noopener">${escHtml(shortUrl(p.url))}</a>
      </td>
      <td>${fsnHtml}</td>
      <td>${skuHtml}</td>
      <td>${myPriceHtml}</td>
      <td>${myStock}</td>
      <td><span class="price-cell ${p.status==='win'?'win':'lose'}">R ${(p.buybox_price||0).toFixed(2)}</span></td>
      <td>${costHtml}</td>
      <td>${minHtml}</td>
      <td>${maxHtml}</td>
      <td>${profitHtml}</td>
      <td style="font-size:12px;max-width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(p.seller||'')}">${escHtml((p.seller||'Unknown').slice(0,20))}</td>
      <td><span class="status-pill ${statusClass}">${statusLabel}</span></td>
      <td style="font-size:11px;color:var(--muted);white-space:nowrap">${t}</td>
      <td style="display:flex;gap:4px">
        <button class="action-btn" onclick="rescrapeOne(${realIdx})" title="Re-scrape">‚Üª</button>
        <button class="action-btn danger" onclick="deleteProduct(${realIdx})" title="Delete">‚úï</button>
      </td>
    </tr>`;
  }).join('');

  // ‚îÄ‚îÄ RESTORE checked state after re-render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (prevChecked.size > 0) {
    document.querySelectorAll('.row-check').forEach(c => {
      if (prevChecked.has(parseInt(c.dataset.idx))) c.checked = true;
    });
  }
}

function toggleSelectAll(cb) {
  document.querySelectorAll('.row-check').forEach(c => c.checked = cb.checked);
}

function refreshSelected() {
  const idxs = Array.from(document.querySelectorAll('.row-check:checked')).map(c => parseInt(c.dataset.idx));
  if (idxs.length === 0) { alert('Tick at least one product to refresh.'); return; }
  if (!state.extReady) { alert('Extension not connected.'); return; }
  const urls = idxs.map(i => state.products[i].url).join('\n');
  switchTab('scraper');
  document.getElementById('urlInput').value = urls;
  document.getElementById('urlCount').textContent = idxs.length + ' URL(s) detected';
  setTimeout(startScraping, 200);
}

function deleteSelected() {
  const idxs = Array.from(document.querySelectorAll('.row-check:checked')).map(c => parseInt(c.dataset.idx));
  if (idxs.length === 0) { alert('Tick at least one product to delete.'); return; }
  if (!confirm('Delete ' + idxs.length + ' selected product(s)?')) return;
  idxs.sort((a,b) => b-a).forEach(i => state.products.splice(i, 1));
  saveProducts(); renderProducts(); updateProductCount();
  document.getElementById('selectAll').checked = false;
}

function importListings(input) {
  const file = input.files[0];
  if (!file) return;

  // Step 1: read as Data URL (no stack overflow risk ‚Äî browser handles it natively)
  const urlReader = new FileReader();
  urlReader.onload = function(urlEvt) {
    // urlEvt.target.result is "data:...;base64,XXXX" ‚Äî extract the base64 part
    const dataUrl = urlEvt.target.result;
    const base64  = dataUrl.split(',')[1];
    localStorage.setItem('makro_listings_raw',      base64);
    localStorage.setItem('makro_listings_filename', file.name);
  };
  urlReader.readAsDataURL(file);

  // Step 2: read as ArrayBuffer to parse with SheetJS
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      // dense:true uses array-of-arrays internally ‚Äî avoids deep recursion on large XLS files
      const wb   = XLSX.read(data, { type: 'array', dense: true, cellStyles: false, cellFormula: false, cellHTML: false });
      const sh   = wb.Sheets[wb.SheetNames[0]];
      const rows = XLSX.utils.sheet_to_json(sh, { header: 1 });
      const listings = [];
      for (let r = 2; r < rows.length; r++) {
        const row = rows[r];
        if (!row || !row[4]) continue;
        const fsn      = String(row[4]  || '').trim();
        const sku      = String(row[1]  || '').trim();
        const title    = String(row[0]  || '').trim();
        const myPrice  = parseFloat(row[9])  || 0;
        const myStock  = parseInt(row[12])   || 0;
        const status   = String(row[6]  || '').trim();
        if (fsn) listings.push({ fsn, sku, title, myPrice, myStock, status });
      }
      localStorage.setItem('makro_listings', JSON.stringify(listings));

      // ‚îÄ‚îÄ Auto-populate SKU on matched products (needed for cost sync) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      // Always overwrite ‚Äî old products may have itm... slugs stored wrongly as SKU
      const fsnToSku = {};
      listings.forEach(l => { if (l.fsn && l.sku) fsnToSku[l.fsn] = l.sku; });
      let skuPopulated = 0;
      state.products.forEach(p => {
        if (p.fsn && fsnToSku[p.fsn]) {
          const newSku = fsnToSku[p.fsn];
          if (p.sku !== newSku) {
            p.sku = newSku;
            skuPopulated++;
          }
        }
        // Also clear any itm... slugs wrongly stored as SKU
        if (p.sku && p.sku.startsWith('itm')) { p.sku = ''; skuPopulated++; }
      });
      if (skuPopulated > 0) saveProducts();

      alert('‚úÖ Imported ' + listings.length + ' listings!' + (skuPopulated > 0 ? ' Auto-populated ' + skuPopulated + ' SKU(s) from listings ‚Äî click üìä Sync Costs to fetch cost prices.' : ' Your prices & stock now show in the Products table.'));
      renderProducts();
    } catch(err) {
      alert('‚ùå Error: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
  input.value = '';
}

function deleteProduct(idx) {
  state.products.splice(idx, 1);
  saveProducts();
  renderProducts();
  updateProductCount();
}

function rescrapeOne(idx) {
  if (!state.extReady) { alert('Extension not connected.'); return; }
  const p = state.products[idx];
  switchTab('scraper');
  document.getElementById('urlInput').value = p.url;
  document.getElementById('urlCount').textContent = '1 URL detected';
  setTimeout(startScraping, 100);
}

function clearAllConfirm() {
  document.getElementById('clearCount').textContent = state.products.length;
  document.getElementById('clearModal').classList.add('show');
}

function clearAll() {
  state.products = [];
  saveProducts();
  document.getElementById('clearModal').classList.remove('show');
  renderProducts();
  updateProductCount();
  renderDashboard();
}

function updateProductCount() {
  document.getElementById('prodCount').textContent = state.products.length;
}

// ============================================================
// COST PRICE INLINE EDIT
// ============================================================
function editCost(idx) {
  document.getElementById('cost-disp-' + idx).style.display = 'none';
  const wrap = document.getElementById('cost-edit-' + idx);
  wrap.style.display = 'flex';
  const inp = document.getElementById('cost-inp-' + idx);
  inp.focus(); inp.select();
}

function cancelCost(idx) {
  document.getElementById('cost-disp-' + idx).style.display = 'flex';
  document.getElementById('cost-edit-' + idx).style.display = 'none';
}

function saveCost(idx) {
  const val = parseFloat(document.getElementById('cost-inp-' + idx).value);
  if (!isNaN(val) && val >= 0) {
    state.products[idx].cost_price = val;
    if (!state.products[idx].cost_supplier) state.products[idx].cost_supplier = 'Manual';
  } else if (document.getElementById('cost-inp-' + idx).value.trim() === '') {
    // Clear cost
    delete state.products[idx].cost_price;
    delete state.products[idx].cost_supplier;
  }
  saveProducts();
  renderProducts();
  showCostNotify('‚úÖ Cost price saved.', 'success');
}

// ============================================================
// GOOGLE SHEETS COST SYNC ‚Äî pure browser fetch, no backend needed
// Sheet: https://docs.google.com/spreadsheets/d/1ISaEOPBElufeYh6eq6APtlFjeMvrKqlAwEd3F4K6rBw
// Reads multiple supplier tabs, matches by SKU, picks lowest cost
// ============================================================
const GSHEET_ID = '1ISaEOPBElufeYh6eq6APtlFjeMvrKqlAwEd3F4K6rBw';

// Define each supplier tab: { gid, skuCol, costCol, minCol, maxCol, supplierName }
// Column indices are 0-based: A=0, B=1, C=2, D=3, ... N=13, O=14, P=15
// The sync picks the LOWEST cost match across all tabs.
const GSHEET_TABS = [
  // Tab gid=2144903566: SKU(A=0), Title(B=1), Stock(C=2), Cost Price(D=3), Min(N=13), Max(O=14)
  { gid: '2144903566', skuCol: 0, costCol: 3, minCol: 13, maxCol: 14, supplierName: 'Kolok' },
  // ‚îÄ‚îÄ Add more supplier tabs below ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Example: { gid: 'YOUR_GID', skuCol: 2, costCol: 13, minCol: 14, maxCol: 15, supplierName: 'Supplier B' },
];

// ‚îÄ‚îÄ Makro fee structure ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// 10% commission on selling price PLUS tiered delivery fee:
//   < R1500  ‚Üí R50
//   R1500‚ÄìR3999.99 ‚Üí R80
//   R4000‚ÄìR9999.99 ‚Üí R100
//   ‚â• R10000  ‚Üí R200
function makroFees(sellingPrice) {
  const commission = sellingPrice * 0.10;
  let delivery = 50;
  if (sellingPrice >= 10000) delivery = 200;
  else if (sellingPrice >= 4000)  delivery = 100;
  else if (sellingPrice >= 1500)  delivery = 80;
  return { commission, delivery, total: commission + delivery };
}
function makroProfit(sellingPrice, costPrice) {
  const fees = makroFees(sellingPrice);
  return sellingPrice - fees.total - costPrice;
}

async function syncCostsFromGSheet() {
  const btn = document.getElementById('syncCostsBtn');
  btn.disabled = true;
  btn.textContent = '‚è≥ Syncing...';
  showCostNotify('‚è≥ Fetching cost data from Google Sheets...', 'success');

  try {
    // ‚îÄ‚îÄ Build SKU list from loaded products ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const productSkus = new Set();
    state.products.forEach(p => { if (p.sku) productSkus.add(p.sku.trim().toLowerCase()); });

    if (productSkus.size === 0) {
      showCostNotify('‚ö†Ô∏è No SKUs found on products. Import your Makro Offers file first (Products tab ‚Üí Import Listings).', 'error');
      return;
    }

    // ‚îÄ‚îÄ Fetch all known supplier tabs via public CSV URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Uses: /gviz/tq?tqx=out:csv&sheet=TABNAME ‚Äî no login required
    const lookup = {}; // sku_lower ‚Üí { cost_price, supplier, min_price, max_price }
    let tabsChecked = 0, tabsFailed = 0;

    // First try GSHEET_TABS hardcoded tabs, then also try the Sync & Costs stored tabs
    const storedCosts  = JSON.parse(localStorage.getItem('makro_costs') || '{}');
    const knownSources = [...new Set(Object.values(storedCosts).map(c => c.source).filter(Boolean))];

    // Combine hardcoded tabs + any tabs already imported via Sync & Costs tab
    const tabsToCheck = [...GSHEET_TABS.map(t => ({ name: null, gid: t.gid, skuCol: t.skuCol, costCol: t.costCol, minCol: t.minCol, maxCol: t.maxCol, supplierName: t.supplierName }))];

    // Also check any tab names we know from previous imports
    knownSources.forEach(name => {
      if (name && !tabsToCheck.find(t => t.supplierName === name)) {
        tabsToCheck.push({ name, gid: null, skuCol: 0, costCol: null, supplierName: name });
      }
    });

    for (const tab of tabsToCheck) {
      // Build URL ‚Äî prefer gid, fall back to sheet name
      const url = tab.gid
        ? `https://docs.google.com/spreadsheets/d/${GSHEET_ID}/gviz/tq?tqx=out:csv&gid=${tab.gid}`
        : `https://docs.google.com/spreadsheets/d/${GSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab.name)}`;

      let csvText = '';
      try {
        const resp = await fetch(url);
        if (!resp.ok) { tabsFailed++; continue; }
        csvText = await resp.text();
        if (csvText.includes('<!DOCTYPE') || csvText.trim().length < 10) { tabsFailed++; continue; }
      } catch(e) { tabsFailed++; continue; }

      tabsChecked++;
      const rows = parseCSV(csvText);
      if (rows.length < 2) continue;

      const headers = rows[0];

      // Auto-detect cost column if not hardcoded
      let costCol = tab.costCol;
      if (costCol == null) {
        costCol = headers.findIndex(h => /cost|price|sell|landed/i.test(h) && !/sku|code|name|desc/i.test(h));
        if (costCol < 0) costCol = 3; // default column D
      }

      const supplierName = tab.supplierName || headers[0] || ('Tab ' + tabsChecked);

      for (let r = 1; r < rows.length; r++) {
        const row = rows[r];
        if (!row || !row[0]) continue;
        const rawSku  = row[0].toString().trim();
        const rawCost = (row[costCol] || '').toString().replace(/[R,\s]/g, '');
        if (!rawSku) continue;
        const costVal = parseFloat(rawCost);
        if (isNaN(costVal) || costVal <= 0) continue;
        const skuKey = rawSku.toLowerCase();

        const rawMin = tab.minCol != null ? (row[tab.minCol] || '').toString().replace(/[R,\s]/g, '') : '';
        const rawMax = tab.maxCol != null ? (row[tab.maxCol] || '').toString().replace(/[R,\s]/g, '') : '';
        const minVal = rawMin ? parseFloat(rawMin) : null;
        const maxVal = rawMax ? parseFloat(rawMax) : null;

        // Keep lowest cost across all supplier tabs
        if (!lookup[skuKey] || costVal < lookup[skuKey].cost_price) {
          lookup[skuKey] = {
            cost_price:  costVal,
            supplier:    supplierName,
            min_price:   (!isNaN(minVal) && minVal > 0) ? minVal : null,
            max_price:   (!isNaN(maxVal) && maxVal > 0) ? maxVal : null,
          };
        }
      }
    }

    // ‚îÄ‚îÄ Match products by SKU ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let updated = 0, notFound = [];
    state.products.forEach(p => {
      const sku = (p.sku || '').trim().toLowerCase();
      if (!sku) return;
      if (lookup[sku]) {
        p.cost_price    = lookup[sku].cost_price;
        p.cost_supplier = lookup[sku].supplier;
        p.minPrice      = lookup[sku].cost_price; // never sell below cost
        if (lookup[sku].min_price) p.min_price = lookup[sku].min_price;
        if (lookup[sku].max_price) p.max_price = lookup[sku].max_price;
        updated++;
      } else {
        notFound.push(p.sku);
      }
    });

    // Also store in makro_costs for use in Sync & Costs tab
    const costsStore = JSON.parse(localStorage.getItem('makro_costs') || '{}');
    Object.entries(lookup).forEach(([sku, data]) => {
      costsStore[sku] = { cost: data.cost_price, source: data.supplier, updated: new Date().toISOString() };
    });
    localStorage.setItem('makro_costs', JSON.stringify(costsStore));

    saveProducts();
    renderProducts();

    const tabInfo  = tabsChecked > 0 ? ` (${tabsChecked} tab${tabsChecked!==1?'s':''} scanned)` : '';
    const skipInfo = notFound.length > 0 ? ` ¬∑ ${notFound.length} SKU(s) not in sheet` : ' ¬∑ All SKUs matched!';
    const msg = updated > 0
      ? `‚úÖ ${updated} product${updated!==1?'s':''} updated with cost data${tabInfo}${skipInfo}`
      : `‚ö†Ô∏è 0 products updated${tabInfo}. Check that SKUs in your products match column A of the Google Sheet.`;
    showCostNotify(msg, updated > 0 ? 'success' : 'error');

  } catch(e) {
    showCostNotify('‚ùå Sync error: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'üìä Sync Costs';
  }
}

// Minimal CSV parser (handles quoted fields with commas/newlines)
function parseCSV(text) {
  const rows = [];
  let row = [], cur = '', inQ = false;
  for (let i = 0; i < text.length; i++) {
    const ch = text[i];
    if (ch === '"') {
      if (inQ && text[i+1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (ch === ',' && !inQ) {
      row.push(cur); cur = '';
    } else if ((ch === '\n' || ch === '\r') && !inQ) {
      if (ch === '\r' && text[i+1] === '\n') i++;
      row.push(cur); rows.push(row); row = []; cur = '';
    } else {
      cur += ch;
    }
  }
  if (cur || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

function showCostNotify(msg, type) {
  const el = document.getElementById('costNotify');
  el.textContent = msg;
  el.className = 'show ' + (type || 'success');
  clearTimeout(el._timer);
  el._timer = setTimeout(() => { el.className = ''; }, 6000);
}

function exportCSV() {
  if (state.products.length === 0) { alert('No products to export.'); return; }
  const headers = ['Title', 'URL', 'FSN', 'SKU', 'BuyBox Price', 'Cost Price', 'Supplier', 'Min Price', 'Max Price', 'Seller', 'Status', 'Last Checked'];
  const rows = state.products.map(p => [
    p.title, p.url, p.fsn, p.sku, p.buybox_price, p.cost_price, p.cost_supplier, p.min_price, p.max_price, p.seller, p.status, p.lastChecked
  ].map(v => '"' + String(v||'').replace(/"/g,'""') + '"'));
  const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'makro-buybox-' + new Date().toISOString().slice(0,10) + '.csv';
  a.click();
}

// ============================================================
// ANALYTICS
// ============================================================
function renderAnalytics() {
  // Always re-evaluate win/lose before rendering analytics
  try { reEvaluateStatuses(); } catch(e) {}
  const prods = state.products;
  renderStatusBars(prods);
  renderPriceChart(prods);
  renderTrendChart(prods);
  renderPriceComp(prods);
  renderCompetitors(prods);
  renderPriceGap(prods);
  renderOpportunities(prods);
  renderSummary(prods);
}

function renderPriceChart(prods) {
  const canvas = document.getElementById('priceChart');
  const empty = document.getElementById('emptyPriceChart');
  if (prods.length === 0) {
    canvas.style.display = 'none'; empty.style.display = 'flex'; return;
  }
  canvas.style.display = 'block'; empty.style.display = 'none';

  const ctx = canvas.getContext('2d');
  const W = canvas.parentElement.offsetWidth - 40;
  canvas.width = W; canvas.height = 180;
  ctx.clearRect(0,0,W,180);

  const prices = prods.map(p => p.buybox_price || 0).filter(v => v > 0);
  if (prices.length === 0) return;

  // Buckets
  const min = prices.reduce((a,b)=>a<b?a:b, Infinity);
  const max = prices.reduce((a,b)=>a>b?a:b, -Infinity);
  const buckets = 8;
  const bSize = (max - min) / buckets || 1;
  const counts = Array(buckets).fill(0);
  prices.forEach(p => {
    const b = Math.min(Math.floor((p - min) / bSize), buckets - 1);
    counts[b]++;
  });

  const maxCount = Math.max(...counts, 1);
  const barW = (W - 40) / buckets - 4;
  const barAreaH = 140;

  counts.forEach((c, i) => {
    const h = (c / maxCount) * barAreaH;
    const x = 20 + i * ((W - 40) / buckets);
    const y = barAreaH - h + 20;
    ctx.fillStyle = '#00e5a0';
    ctx.globalAlpha = 0.7;
    ctx.fillRect(x, y, barW, h);
    ctx.globalAlpha = 1;

    // X label
    ctx.fillStyle = '#6b7280';
    ctx.font = '9px DM Sans';
    ctx.textAlign = 'center';
    ctx.fillText('R' + Math.round(min + i * bSize), x + barW/2, 170);
  });
}

function renderTrendChart(prods) {
  const canvas = document.getElementById('trendChart');
  const empty = document.getElementById('emptyTrendChart');

  // Gather all history points
  const timeline = [];
  prods.forEach(p => {
    (p.history || []).forEach(h => timeline.push(h));
  });
  timeline.sort((a,b) => new Date(a.ts) - new Date(b.ts));

  if (timeline.length < 2) {
    canvas.style.display = 'none'; empty.style.display = 'flex'; return;
  }

  canvas.style.display = 'block'; empty.style.display = 'none';
  const ctx = canvas.getContext('2d');
  const W = canvas.parentElement.offsetWidth - 40;
  canvas.width = W; canvas.height = 180;
  ctx.clearRect(0,0,W,180);

  // Group by day, count wins/loses
  const days = {};
  timeline.forEach(h => {
    const day = h.ts.slice(0,10);
    if (!days[day]) days[day] = { wins:0, loses:0 };
    if (h.status === 'win') days[day].wins++;
    else days[day].loses++;
  });

  const dayKeys = Object.keys(days).sort().slice(-14);
  if (dayKeys.length < 2) { canvas.style.display = 'none'; empty.style.display = 'flex'; return; }

  const maxVal = Math.max(...dayKeys.map(d => days[d].wins + days[d].loses), 1);
  const step = (W - 40) / (dayKeys.length - 1);
  const H = 160;
  const padT = 10, padB = 30;

  function toY(val) { return padT + (1 - val/maxVal) * (H - padT - padB); }

  // Win line
  ctx.beginPath();
  dayKeys.forEach((d, i) => {
    const x = 20 + i * step, y = toY(days[d].wins);
    i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });
  ctx.strokeStyle = '#00e5a0'; ctx.lineWidth = 2; ctx.stroke();

  // Lose line
  ctx.beginPath();
  dayKeys.forEach((d, i) => {
    const x = 20 + i * step, y = toY(days[d].loses);
    i === 0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  });
  ctx.strokeStyle = '#ff4d6d'; ctx.lineWidth = 2; ctx.stroke();

  // Labels
  ctx.fillStyle = '#6b7280'; ctx.font = '9px DM Sans'; ctx.textAlign = 'center';
  dayKeys.forEach((d, i) => {
    if (i % Math.ceil(dayKeys.length / 6) === 0) {
      ctx.fillText(d.slice(5), 20 + i * step, H - 5);
    }
  });

  // Legend
  ctx.fillStyle = '#00e5a0'; ctx.fillRect(W - 80, 15, 10, 2);
  ctx.fillStyle = '#e8eaf0'; ctx.font = '10px DM Sans'; ctx.textAlign = 'left';
  ctx.fillText('Wins', W - 66, 18);
  ctx.fillStyle = '#ff4d6d'; ctx.fillRect(W - 80, 28, 10, 2);
  ctx.fillStyle = '#e8eaf0';
  ctx.fillText('Losses', W - 66, 31);
}

function renderPriceComp(prods) {
  const el = document.getElementById('priceCompBar');
  const empty = document.getElementById('emptyPriceComp');
  const p2 = prods.filter(p => p.buybox_price > 0);
  if (p2.length === 0) { el.style.display='none'; empty.style.display='flex'; return; }
  el.style.display = 'flex'; empty.style.display = 'none';

  const maxPrice = Math.max(...p2.map(p => p.buybox_price), 1);
  el.innerHTML = p2.slice(0,12).map(p => {
    const pct = (p.buybox_price / maxPrice * 100).toFixed(1);
    const color = p.status === 'win' ? 'var(--accent)' : p.status === 'lose' ? 'var(--accent2)' : 'var(--muted)';
    return `<div class="bar-row">
      <div class="bar-label" title="${escHtml(p.title)}">${escHtml((p.title||'?').slice(0,18))}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${color}">
        <span class="bar-fill-val" style="color:#000;font-size:10px">R${p.buybox_price.toFixed(0)}</span>
      </div></div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Status bar chart (now in Analytics tab) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderStatusBars(prods) {
  const el = document.getElementById('statusBarChartAnalytics');
  if (!el) return;
  if (!prods.length) { el.innerHTML = '<div style="color:var(--muted);padding:20px;font-size:13px">No products scraped yet.</div>'; return; }
  const maxPrice = Math.max(...prods.map(p => p.buybox_price || 0), 1);
  el.innerHTML = '<div class="bar-chart">' + prods.map(p => {
    const color = p.status === 'win' ? 'var(--accent)' : p.status === 'lose' ? 'var(--accent2)' : 'var(--muted)';
    const pct = ((p.buybox_price || 0) / maxPrice * 100).toFixed(1);
    const label = (p.title || p.url || 'Unknown').slice(0, 32);
    return `<div class="bar-row">
      <div class="bar-label" title="${escHtml(p.title)}">${escHtml(label)}</div>
      <div class="bar-track"><div class="bar-fill" style="width:${pct}%;background:${color}">
        <span class="bar-fill-val" style="color:#000;font-size:10px">R${(p.buybox_price||0).toFixed(0)} ¬∑ ${escHtml((p.seller||'').slice(0,20))}</span>
      </div></div>
    </div>`;
  }).join('') + '</div>';
}

// ‚îÄ‚îÄ Competitor breakdown ‚Äî FULL names, show % share, avg price ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCompetitors(prods) {
  const el = document.getElementById('compBreakdown');
  const sellerData = {};
  prods.forEach(function(p) {
    if (!p.seller || p.seller === 'Unknown Seller') return;
    if (!sellerData[p.seller]) sellerData[p.seller] = { count: 0, prices: [] };
    sellerData[p.seller].count++;
    if (p.buybox_price > 0) sellerData[p.seller].prices.push(p.buybox_price);
  });

  const myName = getMySellerName().toLowerCase();
  const sorted = Object.entries(sellerData).sort((a, b) => b[1].count - a[1].count);
  const total  = sorted.reduce((s, [, d]) => s + d.count, 0) || 1;
  const max    = sorted.length ? sorted[0][1].count : 1;

  if (!sorted.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:13px">No competitor data yet.</div>';
    return;
  }

  el.innerHTML = sorted.map(function([name, d]) {
    const isMe  = name.toLowerCase().includes(myName) || myName.includes(name.toLowerCase().slice(0, 6));
    const color = isMe ? 'var(--accent)' : 'var(--accent2)';
    const pct   = (d.count / max * 100).toFixed(0);
    const share = (d.count / total * 100).toFixed(1);
    const avg   = d.prices.length ? 'R' + (d.prices.reduce((a,b)=>a+b,0)/d.prices.length).toFixed(0) : '‚Äî';
    return `<div class="bar-row" style="margin-bottom:6px">
      <div class="bar-label" title="${escHtml(name)}" style="width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${escHtml(name)}</div>
      <div class="bar-track" style="flex:1">
        <div class="bar-fill" style="width:${pct}%;background:${color};min-width:2px">
          <span class="bar-fill-val" style="color:#000">${d.count}</span>
        </div>
      </div>
      <div style="font-size:10px;color:var(--muted);white-space:nowrap;margin-left:8px;width:100px;text-align:right">${share}% ¬∑ avg ${avg}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ Price Gap Analysis ‚Äî how far are you from winning ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPriceGap(prods) {
  const el = document.getElementById('priceGapAnalysis');
  if (!el) return;
  const listings = getListings();
  const listMap  = {};
  listings.forEach(function(l) { if (l.fsn) listMap[l.fsn] = l; });

  // Show buybox price distribution by competitor even without listings
  if (!listings.length) {
    // Show top losing competitors with their avg price instead
    const compData = {};
    prods.forEach(function(p) {
      if (!p.seller || p.seller === 'Unknown Seller' || !p.buybox_price) return;
      if (!compData[p.seller]) compData[p.seller] = { count: 0, prices: [] };
      compData[p.seller].count++;
      compData[p.seller].prices.push(p.buybox_price);
    });
    const sorted = Object.entries(compData).sort((a,b) => b[1].count - a[1].count).slice(0,6);
    if (!sorted.length) {
      el.innerHTML = '<div style="color:var(--muted);font-size:12px;line-height:1.6">No BuyBox price data yet. Scrape your products first, then import your S_listing file to see how far your prices are from winning.</div>';
      return;
    }
    const maxCount = sorted[0][1].count;
    el.innerHTML = '<div style="font-size:11px;color:var(--muted);margin-bottom:10px">Import S_listing to see exact gaps. Current competitor avg prices:</div>' +
      sorted.map(function([name, d]) {
        const avg = (d.prices.reduce((a,b)=>a+b,0)/d.prices.length).toFixed(0);
        const pct = (d.count / maxCount * 100).toFixed(0);
        return `<div class="bar-row" style="margin-bottom:5px">
          <div class="bar-label" style="width:130px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(name)}">${escHtml(name.slice(0,18))}</div>
          <div class="bar-track" style="flex:1"><div class="bar-fill" style="width:${pct}%;background:var(--accent2);min-width:2px">
            <span class="bar-fill-val" style="color:#000">${d.count}</span>
          </div></div>
          <div style="font-size:10px;color:var(--muted);white-space:nowrap;margin-left:8px">avg R${avg}</div>
        </div>`;
      }).join('');
    return;
  }

  // Only products where we have both my price and buybox price
  const gaps = [];
  prods.forEach(function(p) {
    if (p.status !== 'lose' && p.status !== 'unknown') return;
    const l = listMap[p.fsn];
    if (!l || !l.myPrice || !p.buybox_price) return;
    const gap = l.myPrice - p.buybox_price;
    gaps.push({ title: p.title, myPrice: l.myPrice, buybox: p.buybox_price, gap, seller: p.seller });
  });

  if (!gaps.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:12px;line-height:1.6">No price gap data yet ‚Äî make sure your S_listing FSN codes match the scraped products.</div>';
    return;
  }

  gaps.sort((a, b) => Math.abs(a.gap) - Math.abs(b.gap));

  const buckets = { '<R10':0, 'R10‚Äì50':0, 'R50‚Äì200':0, 'R200‚Äì500':0, '>R500':0 };
  gaps.forEach(function(g) {
    const a = Math.abs(g.gap);
    if (a < 10)       buckets['<R10']++;
    else if (a < 50)  buckets['R10‚Äì50']++;
    else if (a < 200) buckets['R50‚Äì200']++;
    else if (a < 500) buckets['R200‚Äì500']++;
    else              buckets['>R500']++;
  });

  const maxB = Math.max(...Object.values(buckets), 1);
  const colors = ['#00e5a0','#7ee8c8','#ffd60a','#ff9500','#ff4d6d'];
  el.innerHTML = '<div style="margin-bottom:10px;font-size:11px;color:var(--muted)">' + gaps.length + ' losing products with price data</div>' +
    Object.entries(buckets).map(function([label, count], i) {
      const pct = (count / maxB * 100).toFixed(0);
      return `<div class="bar-row" style="margin-bottom:5px">
        <div class="bar-label" style="width:70px">${label}</div>
        <div class="bar-track" style="flex:1"><div class="bar-fill" style="width:${pct}%;background:${colors[i]};min-width:2px">
          <span class="bar-fill-val" style="color:#000">${count}</span>
        </div></div>
      </div>`;
    }).join('');
}

// ‚îÄ‚îÄ Top Opportunities ‚Äî products closest to winning buybox ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderOpportunities(prods) {
  const el = document.getElementById('opportunityTable');
  if (!el) return;
  const listings = getListings();
  const listMap  = {};
  listings.forEach(function(l) { if (l.fsn) listMap[l.fsn] = l; });

  const opps = [];
  prods.forEach(function(p) {
    if (p.status === 'win') return;
    if (!p.buybox_price) return;
    const l = listMap[p.fsn];
    const myPrice = l ? l.myPrice : null;
    const gap = myPrice ? myPrice - p.buybox_price : null;
    opps.push({ p, myPrice, gap, absGap: gap !== null ? Math.abs(gap) : 999999 });
  });

  opps.sort((a, b) => a.absGap - b.absGap);
  const top = opps.slice(0, 20);

  if (!top.length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:13px;padding:12px">No losing products found. Either everything is winning or no products scraped yet.</div>';
    return;
  }

  el.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:12px">
    <thead><tr style="color:var(--muted);border-bottom:1px solid var(--border)">
      <th style="text-align:left;padding:8px 6px">Product</th>
      <th style="text-align:right;padding:8px 6px">BuyBox</th>
      <th style="text-align:right;padding:8px 6px">My Price</th>
      <th style="text-align:right;padding:8px 6px">Gap</th>
      <th style="text-align:left;padding:8px 6px">BuyBox Owner</th>
      <th style="text-align:center;padding:8px 6px">Action</th>
    </tr></thead>
    <tbody>` +
    top.map(function({ p, myPrice, gap }) {
      const gapStr  = gap !== null ? (gap > 0 ? '<span style="color:#ff9500">‚ñ≤R'+gap.toFixed(2)+'</span>' : '<span style="color:#00e5a0">‚ñºR'+Math.abs(gap).toFixed(2)+'</span>') : '<span style="color:var(--muted)">‚Äî</span>';
      const myPriceStr = myPrice ? 'R'+myPrice.toFixed(2) : '<span style="color:var(--muted)">‚Äî</span>';
      const closeEnough = gap !== null && Math.abs(gap) < 50;
      return `<tr style="border-bottom:1px solid var(--border)${closeEnough ? ';background:rgba(0,229,160,0.04)' : ''}">
        <td style="padding:8px 6px;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${escHtml(p.title)}">${escHtml((p.title||p.url||'').slice(0,40))}</td>
        <td style="text-align:right;padding:8px 6px;font-family:monospace;color:var(--accent)">R${p.buybox_price.toFixed(2)}</td>
        <td style="text-align:right;padding:8px 6px;font-family:monospace">${myPriceStr}</td>
        <td style="text-align:right;padding:8px 6px;font-family:monospace">${gapStr}</td>
        <td style="padding:8px 6px;color:var(--muted);max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(p.seller||'Unknown')}</td>
        <td style="text-align:center;padding:8px 6px"><a href="${escHtml(p.url)}" target="_blank" style="color:var(--accent);font-size:11px;text-decoration:none">Open ‚Üó</a></td>
      </tr>`;
    }).join('') +
    '</tbody></table>';
}

// ‚îÄ‚îÄ Summary Stats ‚Äî enriched ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderSummary(prods) {
  const el = document.getElementById('summaryStats');
  if (!el) return;
  if (!prods.length) { el.innerHTML = '<div style="color:var(--muted);font-size:13px">No data yet</div>'; return; }

  try {
    const wins   = prods.filter(p => p.status === 'win').length;
    const loses  = prods.filter(p => p.status === 'lose').length;
    const unk    = prods.filter(p => !p.status || p.status === 'unknown').length;
    const total  = prods.length;
    const prices = prods.map(p => p.buybox_price).filter(v => v > 0);
    const avg    = prices.length ? prices.reduce((a,b)=>a+b,0)/prices.length : 0;
    // Use reduce instead of spread to avoid stack overflow on large arrays
    const min    = prices.length ? prices.reduce((a,b)=>a<b?a:b, Infinity) : 0;
    const max    = prices.length ? prices.reduce((a,b)=>a>b?a:b, -Infinity) : 0;

    const sellers = {};
    prods.forEach(p => { if (p.seller && p.seller !== 'Unknown Seller') sellers[p.seller] = (sellers[p.seller]||0)+1; });
    const topSeller = Object.entries(sellers).sort((a,b)=>b[1]-a[1])[0];
    const listings  = getListings();

    const rows = [
      ['Total Products',       total,                             ''],
      ['Winning BuyBox',       wins,                              'color:var(--accent)'],
      ['Losing BuyBox',        loses,                             'color:var(--accent2)'],
      ['Unknown / Unscraped',  unk,                               'color:var(--muted)'],
      ['Win Rate',             Math.round(wins/total*100) + '%',  wins > loses ? 'color:var(--accent)' : 'color:var(--accent2)'],
      ['Avg BuyBox Price',     'R ' + avg.toFixed(2),             ''],
      ['Lowest BuyBox Price',  min > 0 ? 'R ' + min.toFixed(2) : '‚Äî', ''],
      ['Highest BuyBox Price', max > 0 ? 'R ' + max.toFixed(2) : '‚Äî', ''],
      ['Unique Competitors',   Object.keys(sellers).length,       ''],
      ['Top Competitor',       topSeller ? topSeller[0] : '‚Äî',    'color:var(--accent2);font-size:11px;text-align:right;max-width:160px'],
      ['Listings Imported',    listings.length,                   listings.length ? 'color:var(--accent)' : 'color:var(--muted)'],
    ];

    el.innerHTML = rows.map(([label, val, style]) => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:7px 0;border-bottom:1px solid var(--border)">
        <span style="font-size:11px;color:var(--muted);flex-shrink:0">${label}</span>
        <span style="font-family:'Space Mono',monospace;font-size:12px;font-weight:700;${style};margin-left:8px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escHtml(String(val))}</span>
      </div>`).join('');
  } catch(err) {
    console.error('[renderSummary error]', err);
    el.innerHTML = '<div style="color:var(--accent2);font-size:12px">Error rendering stats: ' + err.message + '</div>';
  }
}

// ‚îÄ‚îÄ Export / Import all data ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function exportAllData() {
  const payload = {
    exportedAt: new Date().toISOString(),
    version:    2,
    products:   state.products,
    listings:   getListings()
  };
  const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
  const a    = document.createElement('a');
  a.href     = URL.createObjectURL(blob);
  a.download = 'makro_buybox_export_' + new Date().toISOString().slice(0,10) + '.json';
  a.click();
}

function importAllData(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (!data.products) { alert('Invalid export file.'); return; }
      const existing = state.products;
      let added = 0, updated = 0;

      data.products.forEach(function(p) {
        const idx = existing.findIndex(x => x.url === p.url);
        if (idx >= 0) { existing[idx] = Object.assign({}, existing[idx], p); updated++; }
        else          { existing.push(p); added++; }
      });

      if (data.listings && data.listings.length) {
        localStorage.setItem('makro_listings', JSON.stringify(data.listings));
      }

      saveProducts();
      renderDashboard();
      renderProducts();
      renderAnalytics();
      alert('‚úÖ Import complete!\n' + added + ' new products added\n' + updated + ' products updated' +
        (data.listings ? '\n' + data.listings.length + ' listings imported' : ''));
    } catch(err) {
      alert('Failed to parse file: ' + err.message);
    }
  };
  reader.readAsText(file);
  input.value = '';
}

// ============================================================
// SELLER NAME SYNC
// ============================================================
document.getElementById('sellerNameInput').addEventListener('change', function() {
  const v = this.value.trim();
  if (v) localStorage.setItem(SELLER_KEY, v);
  syncSellerConfig();
  // Re-evaluate all product statuses
  const myName = v.toLowerCase();
  state.products.forEach(p => {
    if (p.seller && p.seller !== 'Unknown Seller') {
      p.status = p.seller.toLowerCase().includes(myName) || myName.includes(p.seller.toLowerCase().slice(0,6)) ? 'win' : 'lose';
    }
  });
  saveProducts();
  renderDashboard();
});

document.getElementById('sellerNameConfig').addEventListener('change', function() {
  document.getElementById('sellerNameInput').value = this.value;
  document.getElementById('sellerNameInput').dispatchEvent(new Event('change'));
});

// ============================================================
// INIT
// ============================================================
(function init() {
  loadProducts();

  // Load saved seller name
  const savedSeller = localStorage.getItem(SELLER_KEY);
  if (savedSeller) document.getElementById('sellerNameInput').value = savedSeller;
  syncSellerConfig();

  updateProductCount();
  renderDashboard();

  // Ping extension
  pingExtension();
  setInterval(pingExtension, 3000);

  // Auto-poll localStorage for new products written by bridge.js
  let lastProductCount = state.products.length;
  let lastScrapeTime = localStorage.getItem('makro_last_scrape') || '';
  setInterval(function() {
    const currentScrape = localStorage.getItem('makro_last_scrape') || '';
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    try {
      const fresh = JSON.parse(raw);
      if (fresh.length !== lastProductCount || currentScrape !== lastScrapeTime) {
        lastProductCount = fresh.length;
        lastScrapeTime = currentScrape;
        state.products = fresh;
        reEvaluateStatuses();
        saveProducts();
        updateProductCount();
        renderDashboard();
        // Only re-render products table if no checkboxes are currently selected
        const anyChecked = document.querySelectorAll('.row-check:checked').length > 0;
        if (!anyChecked) renderProducts();
      }
    } catch(e) {}
  }, 3000);

  // Check if ext still alive
  setInterval(function() {
    // If we got a READY message in last 10s, still online (handled by message handler)
  }, 10000);

  console.log('[MakroBuyboxV2] Dashboard loaded. Products:', state.products.length);
})();

// ============================================================
// PRICE UPDATER
// ============================================================
function initPricer() {
  const listings = getListings();
  const el = document.getElementById('pricerListingsStatus');
  if (listings.length === 0) {
    el.innerHTML = '‚ö†Ô∏è <span style="color:#ff9500">No listings imported yet.</span> Go to <b>Products tab ‚Üí üìÇ Import Listings</b> first.';
    document.getElementById('generateBtn').disabled = true;
  } else {
    el.innerHTML = '‚úÖ <span style="color:var(--accent)">' + listings.length + ' listings loaded.</span> Ready to generate.';
    document.getElementById('generateBtn').disabled = false;
    buildPricerPreview();
  }
}

function getListings() {
  try {
    const raw = localStorage.getItem('makro_listings');
    return raw ? JSON.parse(raw) : [];
  } catch(e) { return []; }
}

function calcNewPrice(myPrice, buyboxPrice, strategy, beatBy, floorPct, globalMin, globalMax, productMin) {
  if (!buyboxPrice || buyboxPrice <= 0) return null;
  let newPrice;
  if (strategy === 'match') {
    newPrice = buyboxPrice;
  } else if (strategy === 'beat') {
    newPrice = buyboxPrice - parseFloat(beatBy);
  } else if (strategy === 'pct') {
    newPrice = buyboxPrice * (1 - parseFloat(beatBy) / 100);
  } else if (strategy === 'floor') {
    const floor = myPrice * (1 - parseFloat(floorPct) / 100);
    newPrice = Math.max(buyboxPrice - parseFloat(beatBy), floor);
  }
  newPrice = Math.max(newPrice, 0.01);
  const effectiveMin = Math.max(globalMin !== null ? globalMin : 0, productMin || 0);
  const effectiveMax = globalMax;
  const rawPrice = newPrice;
  if (effectiveMin > 0 && newPrice < effectiveMin) newPrice = effectiveMin;
  if (effectiveMax !== null && newPrice > effectiveMax) newPrice = effectiveMax;
  return {
    price:       Math.round(newPrice * 100) / 100,
    clamped:     Math.round(rawPrice * 100) / 100 !== Math.round(newPrice * 100) / 100,
    clampDir:    rawPrice < effectiveMin ? 'min' : 'max',
    effectiveMin
  };
}

function buildPricerPreview() {
  const listings    = getListings();
  const strategy    = document.getElementById('pricerStrategy').value;
  const beatBy      = document.getElementById('pricerBeatBy').value;
  const floorPct    = document.getElementById('pricerFloor').value;
  const winsOnly    = document.getElementById('pricerWinsOnly').checked;
  const skipUnknown = document.getElementById('pricerSkipUnknown').checked;
  const minEnabled  = document.getElementById('pricerMinEnabled').checked;
  const maxEnabled  = document.getElementById('pricerMaxEnabled').checked;
  const minPrice    = minEnabled ? parseFloat(document.getElementById('pricerMinPrice').value) || 0    : null;
  const maxPrice    = maxEnabled ? parseFloat(document.getElementById('pricerMaxPrice').value) || 9999 : null;

  const scrapedMap = {};
  state.products.forEach(function(p) { if (p.fsn) scrapedMap[p.fsn] = p; });

  const rows = [];
  listings.forEach(function(l) {
    const scraped = scrapedMap[l.fsn];
    if (!scraped) return;
    if (skipUnknown && (!scraped.buybox_price || scraped.buybox_price <= 0)) return;
    if (winsOnly && scraped.status === 'win') return;
    const prodMin = scraped.minPrice || l.minPrice || 0;
    const result = calcNewPrice(l.myPrice, scraped.buybox_price, strategy, beatBy, floorPct, minPrice, maxPrice, prodMin);
    if (!result) return;
    rows.push({
      fsn:          l.fsn,
      sku:          l.sku,
      title:        l.title,
      myPrice:      l.myPrice,
      buybox:       scraped.buybox_price,
      newPrice:     result.price,
      clamped:      result.clamped,
      clampDir:     result.clampDir,
      effectiveMin: result.effectiveMin || 0,
      status:       scraped.status,
      seller:       scraped.seller
    });
  });

  const el = document.getElementById('pricerPreview');
  if (rows.length === 0) {
    el.innerHTML = '<div style="color:var(--muted);padding:20px">No products match the current strategy settings.</div>';
    return;
  }

  const okRows      = rows.filter(function(r) { return !r.clamped; });
  const clampedRows = rows.filter(function(r) { return  r.clamped; });

  let html = '';
  if (clampedRows.length) {
    html += '<div style="background:rgba(255,149,0,0.1);border:1px solid #ff9500;border-radius:6px;padding:8px 12px;margin-bottom:10px;font-size:11px">' +
      '‚ö†Ô∏è <b style="color:#ff9500">' + clampedRows.length + ' product' + (clampedRows.length > 1 ? 's' : '') + ' clamped by price guard</b> ‚Äî ' +
      'these will be <b>skipped</b> from the upload file to protect you from pricing mistakes.<br>' +
      '<span style="color:var(--muted)">Adjust your Min/Max guards or strategy if you want to include them.</span></div>';
  }

  html += '<div style="margin-bottom:8px;font-size:12px">' +
    '<span style="color:var(--accent)">' + okRows.length + ' products will update</span>' +
    (clampedRows.length ? ' &nbsp;¬∑&nbsp; <span style="color:#ff9500">' + clampedRows.length + ' skipped (clamped)</span>' : '') +
    '</div>' +
    '<table style="width:100%;border-collapse:collapse;font-size:11px">' +
    '<thead><tr style="color:var(--muted);border-bottom:1px solid var(--border)">' +
    '<th style="text-align:left;padding:6px 4px">Product</th>' +
    '<th style="text-align:right;padding:6px 4px">My Price</th>' +
    '<th style="text-align:right;padding:6px 4px">BuyBox</th>' +
    '<th style="text-align:right;padding:6px 4px">New Price</th>' +
    '<th style="text-align:right;padding:6px 4px">Change</th>' +
    '<th style="text-align:right;padding:6px 4px">Cost/Min</th>' +
    '</tr></thead><tbody>';

  // Show OK rows first, then clamped (faded)
  const displayRows = okRows.concat(clampedRows).slice(0, 50);
  displayRows.forEach(function(r) {
    const change      = r.newPrice - r.myPrice;
    const changeColor = r.clamped ? '#ff9500' : (change < 0 ? '#ff9500' : 'var(--accent)');
    const changeStr   = (change >= 0 ? '+' : '') + 'R' + change.toFixed(2);
    const rowStyle    = r.clamped ? 'opacity:0.5;background:rgba(255,149,0,0.05)' : '';
    const clampBadge  = r.clamped ? ' <span style="color:#ff9500;font-size:9px">‚ö† ' + r.clampDir.toUpperCase() + '</span>' : '';
    html += '<tr style="border-bottom:1px solid var(--border);' + rowStyle + '">' +
      '<td style="padding:5px 4px;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + escHtml(r.title) + '">' +
        escHtml(r.title.slice(0, 28)) + clampBadge + '</td>' +
      '<td style="text-align:right;padding:5px 4px;color:var(--muted)">R' + r.myPrice.toFixed(2) + '</td>' +
      '<td style="text-align:right;padding:5px 4px;color:var(--muted)">R' + r.buybox.toFixed(2) + '</td>' +
      '<td style="text-align:right;padding:5px 4px;color:' + (r.clamped ? '#ff9500' : 'var(--accent)') + ';font-weight:700">R' + r.newPrice.toFixed(2) + '</td>' +
      '<td style="text-align:right;padding:5px 4px;color:' + changeColor + '">' + changeStr + '</td>' +
      '</tr>';
  });

  if (rows.length > 50) {
    html += '<tr><td colspan="5" style="color:var(--muted);padding:8px">...and ' + (rows.length - 50) + ' more</td></tr>';
  }
  html += '</tbody></table>';
  el.innerHTML = html;
}

// Recalculate preview when any setting changes
['pricerStrategy','pricerBeatBy','pricerFloor','pricerWinsOnly','pricerSkipUnknown','pricerMinPrice','pricerMaxPrice'].forEach(function(id) {
  document.getElementById(id) && document.getElementById(id).addEventListener('change', function() {
    if (document.getElementById('tab-pricer').classList.contains('active')) buildPricerPreview();
  });
  document.getElementById(id) && document.getElementById(id).addEventListener('input', function() {
    if (document.getElementById('tab-pricer').classList.contains('active')) buildPricerPreview();
  });
});

function generatePriceUpdate() {
  const listings    = getListings();
  const strategy    = document.getElementById('pricerStrategy').value;
  const beatBy      = document.getElementById('pricerBeatBy').value;
  const floorPct    = document.getElementById('pricerFloor').value;
  const winsOnly    = document.getElementById('pricerWinsOnly').checked;
  const skipUnknown = document.getElementById('pricerSkipUnknown').checked;
  const minEnabled  = document.getElementById('pricerMinEnabled').checked;
  const maxEnabled  = document.getElementById('pricerMaxEnabled').checked;
  const minPrice    = minEnabled ? parseFloat(document.getElementById('pricerMinPrice').value) || 0    : null;
  const maxPrice    = maxEnabled ? parseFloat(document.getElementById('pricerMaxPrice').value) || 9999 : null;

  // Check we have the raw template file
  const rawBase64  = localStorage.getItem('makro_listings_raw');
  const rawFilename = localStorage.getItem('makro_listings_filename') || 'S_listing_price_update.xls';
  if (!rawBase64) {
    document.getElementById('pricerResult').innerHTML =
      '‚ùå <span style="color:#ff4444">Original listing file not found.<br>Please re-import your S_listing XLS file from the Products tab ‚Äî the raw file is needed as a template.</span>';
    return;
  }

  // Build FSN ‚Üí new price map
  const scrapedMap = {};
  state.products.forEach(function(p) { if (p.fsn) scrapedMap[p.fsn] = p; });

  const priceMap = {};  // fsn ‚Üí new selling price
  let updateCount = 0;
  let skippedClamped = 0;
  listings.forEach(function(l) {
    const scraped = scrapedMap[l.fsn];
    if (!scraped) return;
    if (skipUnknown && (!scraped.buybox_price || scraped.buybox_price <= 0)) return;
    if (winsOnly && scraped.status === 'win') return;
    const prodMin = scraped.minPrice || l.minPrice || 0;
    const result = calcNewPrice(l.myPrice, scraped.buybox_price, strategy, beatBy, floorPct, minPrice, maxPrice, prodMin);
    if (!result) return;
    if (result.clamped) { skippedClamped++; return; }  // skip clamped ‚Äî protect from mistakes
    priceMap[l.fsn] = result.price;
    updateCount++;
  });

  if (updateCount === 0) {
    document.getElementById('pricerResult').innerHTML = '‚ö†Ô∏è No products to update with current settings.';
    return;
  }

  // Load the original workbook as template ‚Äî keep ALL sheets, ALL columns, ALL rows intact
  // Only modify column J (index 9 = "Your Selling Price") for matching FSNs
  try {
    const byteStr = atob(rawBase64);
    const bytes   = new Uint8Array(byteStr.length);
    for (let i = 0; i < byteStr.length; i++) bytes[i] = byteStr.charCodeAt(i);

    const wb = XLSX.read(bytes, { type: 'array' });
    const sh = wb.Sheets[wb.SheetNames[0]];

    // Get all rows as array of arrays to find which rows to update
    const rows = XLSX.utils.sheet_to_json(sh, { header: 1, defval: '' });

    // Row 0 = headers, Row 1 = descriptions, Row 2+ = data
    // Col index 4 = FSN, Col index 9 = Your Selling Price
    let changed = 0;
    for (let r = 2; r < rows.length; r++) {
      const fsn = String(rows[r][4] || '').trim();
      if (fsn && priceMap[fsn] !== undefined) {
        // Update the cell directly in the sheet object
        const cellAddr = XLSX.utils.encode_cell({ r: r, c: 9 });
        if (!sh[cellAddr]) sh[cellAddr] = {};
        sh[cellAddr].t = 'n';
        sh[cellAddr].v = priceMap[fsn];
        sh[cellAddr].w = String(priceMap[fsn]);
        changed++;
      }
    }

    // Use the original filename structure but with today's date
    const dateStr = new Date().toISOString().slice(0,10).replace(/-/g,'');
    const timeStr = new Date().toTimeString().slice(0,5).replace(':','');
    // Match original naming: S_listing--ui--group_XXXX_DDMM-HHMMSS_default.xls
    const filename = rawFilename.replace(/(_\d{4}-\d{6}_default)/, '_' + dateStr.slice(4) + '-' + timeStr + '00_default');

    // Write back as XLS (same format as original)
    const wbout = XLSX.write(wb, { bookType: 'xls', type: 'array' });
    const wbBytes = new Uint8Array(wbout);
    let base64 = '';
    const CHUNK = 8192;
    for (let i = 0; i < wbBytes.length; i += CHUNK) {
      base64 += String.fromCharCode.apply(null, wbBytes.subarray(i, i + CHUNK));
    }
    base64 = btoa(base64);

    // Save to localStorage for portal auto-upload
    localStorage.setItem('portal_upload_file', base64);
    localStorage.setItem('portal_upload_filename', filename);

    // Also trigger download for manual fallback
    XLSX.writeFile(wb, filename);

    document.getElementById('pricerResult').innerHTML =
      '‚úÖ <span style="color:var(--accent)">Downloaded <b>' + filename + '</b><br>' +
      changed + ' prices updated.' +
      (skippedClamped ? ' <span style="color:#ff9500">' + skippedClamped + ' skipped (price guard).</span>' : '') +
      '</span><br>' +
      '<span style="color:var(--muted)">Click <b>üöÄ Open Seller Portal</b> to auto-upload.</span>';

    document.getElementById('portalUploadBtn').style.display = 'block';
    buildPricerPreview();

  } catch(err) {
    document.getElementById('pricerResult').innerHTML =
      '‚ùå <span style="color:#ff4444">Error building file: ' + err.message + '<br>Please re-import your listing file.</span>';
  }
}

function openPortalUpload() {
  const base64   = localStorage.getItem('portal_upload_file');
  const filename = localStorage.getItem('portal_upload_filename');
  if (!base64) { alert('Generate a price update file first.'); return; }

  // Save into chrome.storage so portal.js can read it
  window.postMessage({ type: 'SAVE_PORTAL_FILE', base64, filename }, '*');

  // Open the seller portal ‚Äî portal.js will inject the BuyBox Pro overlay
  // regardless of which page loads. Navigate to My Listings from there.
  setTimeout(function() {
    window.open('https://seller.makro.co.za', '_blank');
  }, 600);

  document.getElementById('pricerResult').innerHTML +=
    '<br><span style="color:#ffd60a">‚úÖ File saved to extension. On the portal page, click ' +
    '<b style="color:#00e5a0">üöÄ Auto Upload Now</b> in the green overlay to replay your recorded steps.</span>';
}

// ============================================================
// GITHUB GIST SYNC
// ============================================================
async function gistPush() {
  const token  = localStorage.getItem('gist_token') || '';
  const gistId = localStorage.getItem('gist_id')    || '';
  if (!token) { showGistStatus('‚ö†Ô∏è Enter your GitHub token first', '#ff9500'); return; }
  const payload = JSON.stringify({
    products:   state.products,
    listings:   JSON.parse(localStorage.getItem('makro_listings') || '[]'),
    costs:      JSON.parse(localStorage.getItem('makro_costs')    || '{}'),
    sellerName: localStorage.getItem('makro_seller_name') || '',
    pushedAt:   new Date().toISOString()
  });
  showGistStatus('‚¨Ü Pushing ' + state.products.length + ' products...', '#ffd60a');
  try {
    const isNew = !gistId;
    const res = await fetch(isNew ? 'https://api.github.com/gists' : 'https://api.github.com/gists/' + gistId, {
      method:  isNew ? 'POST' : 'PATCH',
      headers: { 'Authorization': 'token ' + token, 'Content-Type': 'application/json' },
      body: JSON.stringify({ description: 'Makro BuyBox Pro auto-sync', public: false,
        files: { 'makro_buybox_data.json': { content: payload } } })
    });
    if (!res.ok) { const e = await res.json(); throw new Error(e.message || res.status); }
    const data = await res.json();
    if (isNew) {
      localStorage.setItem('gist_id', data.id);
      document.getElementById('gistIdInput').value = data.id;
      document.getElementById('gistIdDisplay').textContent = data.id;
      document.getElementById('gistIdRow').style.display = 'flex';
      showGistStatus('‚úÖ Gist created! Copy the ID above and paste it on your other PC.', '#00e5a0');
    } else {
      showGistStatus('‚úÖ Pushed ' + state.products.length + ' products at ' + new Date().toLocaleTimeString(), '#00e5a0');
    }
    document.getElementById('gistLastSync').textContent = 'Last push: ' + new Date().toLocaleTimeString();
  } catch(e) { showGistStatus('‚ùå Push failed: ' + e.message, '#ff4444'); }
}

async function gistPull(silent) {
  const token  = localStorage.getItem('gist_token') || '';
  const gistId = localStorage.getItem('gist_id')    || '';
  if (!token || !gistId) { if (!silent) showGistStatus('‚ö†Ô∏è Enter token and Gist ID first', '#ff9500'); return; }
  try {
    if (!silent) showGistStatus('‚¨á Pulling...', '#ffd60a');
    const res = await fetch('https://api.github.com/gists/' + gistId, {
      headers: { 'Authorization': 'token ' + token }
    });
    if (!res.ok) throw new Error('GitHub returned ' + res.status);
    const gist    = await res.json();
    const content = gist.files['makro_buybox_data.json'] && gist.files['makro_buybox_data.json'].content;
    if (!content) throw new Error('Data file not found in gist');
    const data = JSON.parse(content);
    const merged = {};
    (data.products || []).forEach(function(p) { if (p.url) merged[p.url] = p; });
    state.products.forEach(function(p) {
      if (!p.url) return;
      if (!merged[p.url]) { merged[p.url] = p; return; }
      const remoteTs = new Date(merged[p.url].lastChecked || 0).getTime();
      const localTs  = new Date(p.lastChecked || 0).getTime();
      if (localTs > remoteTs) merged[p.url] = p;
    });
    state.products = Object.values(merged);
    saveProducts(); reEvaluateStatuses(); renderProducts(); renderDashboard(); updateProductCount();
    if (data.listings && data.listings.length) localStorage.setItem('makro_listings', JSON.stringify(data.listings));
    if (data.costs)    localStorage.setItem('makro_costs', JSON.stringify(data.costs));
    const pushedAt = data.pushedAt ? new Date(data.pushedAt).toLocaleString() : 'unknown';
    if (!silent) showGistStatus('‚úÖ Pulled ' + state.products.length + ' products (last push: ' + pushedAt + ')', '#00e5a0');
    document.getElementById('gistLastSync').textContent = 'Last sync: ' + new Date().toLocaleTimeString();
    renderCostCoverage();
  } catch(e) { if (!silent) showGistStatus('‚ùå Pull failed: ' + e.message, '#ff4444'); }
}

function showGistStatus(msg, color) {
  const el = document.getElementById('gistStatus');
  if (el) { el.textContent = msg; el.style.color = color || 'var(--muted)'; }
}

setInterval(function() {
  if (localStorage.getItem('gist_token') && localStorage.getItem('gist_id')) gistPull(true);
}, 5 * 60 * 1000);

function initSyncTab() {
  const token  = localStorage.getItem('gist_token') || '';
  const gistId = localStorage.getItem('gist_id')    || '';
  const tEl = document.getElementById('gistTokenInput');
  const gEl = document.getElementById('gistIdInput');
  if (tEl && !tEl.value) tEl.value = token;
  if (gEl && !gEl.value) gEl.value = gistId;
  if (gistId) {
    document.getElementById('gistIdDisplay').textContent = gistId;
    document.getElementById('gistIdRow').style.display   = 'flex';
  }
  renderCostCoverage();
}

// ============================================================
// GOOGLE SHEET COST IMPORTER (no API key ‚Äî public CSV)
// ============================================================
// GSHEET_ID already declared above ‚Äî reusing it here

async function loadSheetTabs() {
  showCostStatus('‚è≥ Probing supplier sheet tabs...', '#ffd60a');
  const found = [];

  // Try all hardcoded GSHEET_TABS first
  for (const tab of GSHEET_TABS) {
    const url = 'https://docs.google.com/spreadsheets/d/' + GSHEET_ID + '/gviz/tq?tqx=out:csv&gid=' + tab.gid;
    try {
      const res = await fetch(url);
      if (res.ok) {
        const text = await res.text();
        if (text && !text.includes('<!DOCTYPE') && text.trim().length > 5) {
          // Get tab name from first row headers
          const rows = parseCSV(text);
          const label = tab.supplierName || ('GID ' + tab.gid);
          found.push({ name: label, gid: tab.gid, rows });
        }
      }
    } catch(e) {}
  }

  // Also try previously imported tab names stored in makro_costs
  const storedCosts = JSON.parse(localStorage.getItem('makro_costs') || '{}');
  const knownNames  = [...new Set(Object.values(storedCosts).map(c => c.source).filter(Boolean))];
  for (const name of knownNames) {
    if (found.find(f => f.name === name)) continue;
    const url = 'https://docs.google.com/spreadsheets/d/' + GSHEET_ID + '/gviz/tq?tqx=out:csv&sheet=' + encodeURIComponent(name);
    try {
      const res = await fetch(url);
      if (res.ok) {
        const text = await res.text();
        if (text && !text.includes('<!DOCTYPE') && text.trim().length > 5) {
          const rows = parseCSV(text);
          found.push({ name, gid: null, rows });
        }
      }
    } catch(e) {}
  }

  if (found.length > 0) {
    renderTabButtons(found.map(f => f.name));
    showCostStatus('‚úÖ Found ' + found.length + ' supplier tab(s) ‚Äî click one to preview & import', '#00e5a0');
  } else {
    showCostStatus('‚ö†Ô∏è Could not auto-load tabs. Type a tab name below and click Preview.', '#ff9500');
    document.getElementById('costTabSelector').innerHTML =
      '<div style="font-size:11px;color:var(--muted)">Type the exact tab name from your Google Sheet below.</div>';
  }
}

function renderTabButtons(tabs) {
  const el = document.getElementById('costTabSelector');
  if (!el) return;
  el.innerHTML = '<div style="font-size:11px;color:var(--muted);margin-bottom:8px">Select a supplier tab:</div>' +
    '<div style="display:flex;flex-wrap:wrap;gap:6px">' +
    tabs.map(t => '<button onclick="previewTab(\'' + t.replace(/'/g,"\\'") + '\');' +
      'document.querySelectorAll(\'#costTabSelector button\').forEach(b=>b.style.borderColor=\'var(--border)\');this.style.borderColor=\'var(--accent)\'"' +
      ' style="background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:5px 12px;border-radius:5px;cursor:pointer;font-size:11px">' +
      escHtml(t) + '</button>').join('') + '</div>';
}

// parseCSV already declared above ‚Äî reusing it

async function previewTab(tabName) {
  if (!tabName || !tabName.trim()) { showCostStatus('‚ö†Ô∏è Enter a tab name', '#ff9500'); return; }
  tabName = tabName.trim();
  showCostStatus('‚è≥ Loading "' + tabName + '"...', '#ffd60a');
  try {
    const url = 'https://docs.google.com/spreadsheets/d/' + GSHEET_ID + '/gviz/tq?tqx=out:csv&sheet=' + encodeURIComponent(tabName);
    const res  = await fetch(url);
    if (!res.ok) throw new Error('HTTP ' + res.status);
    const text = await res.text();
    if (!text.trim() || text.includes('<!DOCTYPE')) throw new Error('Tab not found or sheet is private');
    const rows = parseCSV(text);
    if (rows.length < 2) throw new Error('Tab appears empty');
    const headers  = rows[0];
    const guessIdx = headers.findIndex(h => /cost|price|sell|landed|rate|amount/i.test(h) && !/sku|code|name|desc|item|ref/i.test(h));
    const guessCol = guessIdx >= 0 ? guessIdx : 1;
    const sampleJson = JSON.stringify(rows.slice(1,6));
    const headersJson = JSON.stringify(headers);
    const allRowsJson = JSON.stringify(rows.slice(1));
    const picker = document.getElementById('costColumnPicker');
    picker.style.display = 'block';
    picker.innerHTML =
      '<div style="font-size:12px;color:var(--muted);margin-bottom:10px"><b style="color:var(--text)">' + escHtml(tabName) + '</b> ‚Äî ' + (rows.length-1) + ' rows ¬∑ Column A = SKU. Pick your cost column:</div>' +
      '<div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px">' +
        '<select id="costColSelect" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:7px 10px;border-radius:6px;font-size:12px" onchange="updateCostPreview(' + sampleJson + ')">' +
          headers.map((h,i) => '<option value="' + i + '"' + (i===guessCol?' selected':'') + '>' + String.fromCharCode(65+Math.min(i,25)) + ': ' + escHtml(h||'(empty)') + '</option>').join('') +
        '</select>' +
        '<button onclick="applyTabCosts(\'' + tabName.replace(/'/g,"\\'") + '\',' + headersJson + ',' + allRowsJson + ')" class="btn-primary" style="width:auto;padding:8px 18px;font-size:12px">‚úÖ Import This Tab</button>' +
      '</div>' +
      '<div id="costPreviewRows" style="font-size:11px;color:var(--muted)"></div>';
    updateCostPreview(rows.slice(1,6));
    showCostStatus('‚úÖ "' + tabName + '" loaded ‚Äî ' + (rows.length-1) + ' rows. Pick cost column and click Import.', '#00e5a0');
  } catch(e) { showCostStatus('‚ùå ' + e.message, '#ff4444'); }
}

function updateCostPreview(sampleRows) {
  const colIdx = parseInt(document.getElementById('costColSelect').value);
  const el = document.getElementById('costPreviewRows');
  if (!el) return;
  el.innerHTML = 'Preview: ' + sampleRows.slice(0,5).filter(r=>r[0]).map(r =>
    '<b>' + escHtml(String(r[0]||'')) + '</b> ‚Üí <span style="color:var(--accent)">R' +
    (parseFloat(String(r[colIdx]||'0').replace(/[^0-9.]/g,''))||0).toFixed(2) + '</span>'
  ).join(' &nbsp;¬∑&nbsp; ');
}

function applyTabCosts(tabName, headers, rows) {
  const colIdx = parseInt(document.getElementById('costColSelect').value);
  const costs  = JSON.parse(localStorage.getItem('makro_costs') || '{}');
  let matched = 0, stored = 0;
  rows.forEach(function(row) {
    const sku  = String(row[0]||'').trim();
    const cost = parseFloat(String(row[colIdx]||'').replace(/[^0-9.]/g,''));
    if (!sku || isNaN(cost) || cost <= 0) return;
    costs[sku] = { cost, source: tabName, col: headers[colIdx], updated: new Date().toISOString() };
    let found = false;
    state.products.forEach(function(p) {
      if (p.sku === sku || p.fsn === sku) { p.minPrice = cost; found = true; }
    });
    if (found) matched++; else stored++;
  });
  localStorage.setItem('makro_costs', JSON.stringify(costs));
  saveProducts();
  renderCostCoverage();
  if (document.getElementById('tab-pricer').classList.contains('active')) buildPricerPreview();
  showCostStatus('‚úÖ Imported from "' + tabName + '": <span style="color:var(--accent)">' + matched + ' products updated</span> ¬∑ <span style="color:var(--muted)">' + stored + ' stored (not scraped yet)</span>', '#00e5a0');
}

function showCostStatus(msg, color) {
  const el = document.getElementById('costStatus');
  if (el) { el.innerHTML = msg; el.style.color = color || 'var(--muted)'; }
}

function renderCostCoverage() {
  const el = document.getElementById('costCoverageTable');
  if (!el) return;
  const costs = JSON.parse(localStorage.getItem('makro_costs') || '{}');
  if (!Object.keys(costs).length) {
    el.innerHTML = '<div style="color:var(--muted);font-size:12px;padding:10px">No costs imported yet.</div>'; return;
  }
  const withCost = state.products.filter(p => costs[p.sku] || costs[p.fsn]);
  const without  = state.products.filter(p => !costs[p.sku] && !costs[p.fsn]);
  let html = '<div style="font-size:12px;margin-bottom:12px"><span style="color:var(--accent)">' + withCost.length + ' have cost data</span> ¬∑ <span style="color:#ff9500">' + without.length + ' missing</span> ¬∑ <span style="color:var(--muted)">' + Object.keys(costs).length + ' SKUs stored</span></div>';
  if (withCost.length) {
    html += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:11px">' +
      '<thead><tr style="color:var(--muted);border-bottom:1px solid var(--border)">' +
      '<th style="text-align:left;padding:5px 8px">Product</th><th style="text-align:left;padding:5px 8px">SKU</th>' +
      '<th style="text-align:right;padding:5px 8px">Cost</th><th style="text-align:right;padding:5px 8px">Min Price</th>' +
      '<th style="text-align:right;padding:5px 8px">BuyBox & Margin</th><th style="text-align:left;padding:5px 8px">Supplier</th>' +
      '</tr></thead><tbody>' +
      withCost.slice(0,200).map(function(p) {
        const c = costs[p.sku] || costs[p.fsn] || {};
        const margin = p.buybox_price > 0 && c.cost > 0 ? ((p.buybox_price - c.cost) / p.buybox_price * 100).toFixed(1) + '%' : '‚Äî';
        const mc = parseFloat(margin) > 20 ? 'var(--accent)' : parseFloat(margin) > 10 ? '#ffd60a' : '#ff9500';
        return '<tr style="border-bottom:1px solid var(--border)">' +
          '<td style="padding:5px 8px;max-width:220px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + escHtml((p.title||'').slice(0,40)) + '</td>' +
          '<td style="padding:5px 8px;font-family:monospace;font-size:10px;color:var(--muted)">' + escHtml(p.sku||p.fsn||'') + '</td>' +
          '<td style="text-align:right;padding:5px 8px;color:var(--accent3)">R' + (c.cost||0).toFixed(2) + '</td>' +
          '<td style="text-align:right;padding:5px 8px;color:var(--accent)">R' + (p.minPrice||c.cost||0).toFixed(2) + '</td>' +
          '<td style="text-align:right;padding:5px 8px;color:' + mc + '">' + (p.buybox_price > 0 ? 'R' + p.buybox_price.toFixed(2) + ' (' + margin + ')' : '‚Äî') + '</td>' +
          '<td style="padding:5px 8px;font-size:10px;color:var(--muted)">' + escHtml(c.source||'') + '</td></tr>';
      }).join('') + '</tbody></table></div>';
  }
  el.innerHTML = html;
}
</script>
</body>
</html>
